<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sourcing Command Center v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-card: #2a2a2a;
            --bg-hover: #353535;
            --border-color: #404040;
            --border-hover: #505050;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --accent-primary: #00d4ff;
            --accent-secondary: #0099cc;
            --accent-glow: rgba(0, 212, 255, 0.5);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient-primary: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            --gradient-card: linear-gradient(135deg, rgba(42, 42, 42, 0.9) 0%, rgba(42, 42, 42, 0.7) 100%);
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        /* Glassmorphism Effects */
        .glass {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-dark {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Glow Effects */
        .glow-primary {
            box-shadow: 0 0 30px var(--accent-glow);
        }
        
        .glow-subtle {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }
        
        /* Text Gradients */
        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .animate-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-slide {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-hover);
        }
        
        /* Button Styles - Enhanced for visibility */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            font-weight: 500;
            letter-spacing: 0.025em;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: #000000;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.6);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .btn-icon:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            transform: translateY(-1px);
        }
        
        /* Card Styles - Enhanced visibility */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card-elevated {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Navigation Styles */
        .nav-item {
            position: relative;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 1px solid transparent;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: var(--gradient-primary);
            transition: height 0.3s ease;
            border-radius: 0 3px 3px 0;
        }
        
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            padding-left: 1.25rem;
            border-color: var(--border-color);
        }
        
        .nav-item.active {
            background: var(--bg-hover);
            color: var(--accent-primary);
            border-color: var(--border-color);
        }
        
        .nav-item.active::before {
            height: 70%;
        }
        
        /* Input Styles */
        .input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
            background: var(--bg-hover);
        }
        
        .input-group {
            position: relative;
        }
        
        .input-label {
            position: absolute;
            left: 1rem;
            top: -0.5rem;
            background: var(--bg-card);
            padding: 0 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        /* Select Styles */
        .select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23b0b0b0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }
        
        .select:focus {
            outline: none;
            border-color: var(--accent-primary);
            background-color: var(--bg-hover);
        }
        
        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.025em;
        }
        
        .badge-primary {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-primary);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .badge-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Modal Styles */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
            text-align: left;
            padding: 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .table tr:hover td {
            background: var(--bg-hover);
        }
        
        /* Loading Spinner */
        .spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Modal Close Button */
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .close-button:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }
        
        /* Notification Styles */
        .notification {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }
        
        .notification-success {
            border-left: 4px solid var(--success);
        }
        
        .notification-error {
            border-left: 4px solid var(--error);
        }
        
        .notification-warning {
            border-left: 4px solid var(--warning);
        }
        
        .notification-info {
            border-left: 4px solid var(--accent-primary);
        }
        
        /* Progress Bar */
        .progress {
            background: var(--bg-tertiary);
            height: 0.5rem;
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 9999px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--bg-tertiary);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .drop-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, var(--accent-glow) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .drop-zone:hover {
            border-color: var(--accent-primary);
            background: var(--bg-hover);
        }
        
        .drop-zone.active {
            border-color: var(--accent-primary);
            background: rgba(0, 212, 255, 0.05);
        }
        
        .drop-zone.active::before {
            opacity: 0.3;
        }
        
        /* Tab Styles */
        .tab {
            position: relative;
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        
        .tab-active {
            color: var(--accent-primary);
            border-bottom: 2px solid var(--accent-primary);
        }
        
        /* Stat Card */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            opacity: 0.1;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0.5rem 0;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            height: 100vh;
            position: sticky;
            top: 0;
        }
        
        /* Main Content */
        .main-content {
            background: var(--bg-primary);
            min-height: 100vh;
        }
        
        /* Header Bar */
        .header-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Candidate Card Enhanced */
        .candidate-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .candidate-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--gradient-primary);
            border-radius: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .candidate-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .candidate-card:hover::before {
            opacity: 0.3;
        }
        
        .candidate-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .candidate-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .candidate-role {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .candidate-skills {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .button-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .button-icon {
            width: 1rem;
            height: 1rem;
        }
        
        .icon-button {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        .icon-button:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: scale(1.1);
        }
        
        /* Skills Tag */
        .skill-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        .skill-tag:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        /* Icon Styles */
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            color: var(--text-secondary);
        }
        
        .icon-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .icon-lg {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        /* Section Header */
        .section-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .section-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .empty-state-icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            color: var(--text-tertiary);
        }
        
        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .empty-state-text {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        
        /* Divider */
        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 1.5rem 0;
        }
        
        /* Avatar */
        .avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--bg-primary);
        }
        
        /* Status Indicator */
        .status-indicator {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-online {
            background: var(--success);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .status-offline {
            background: var(--text-tertiary);
        }
        
        .status-busy {
            background: var(--error);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
        }
        
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .tooltip:hover .tooltip-content {
            opacity: 1;
        }
        
        /* Tag Styles */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .tag-strong {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .tag-potential {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .tag-low {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Demob Specific Styles */
        .demob-urgent {
            border-left: 4px solid var(--error);
        }
        
        .demob-warning {
            border-left: 4px solid var(--warning);
        }
        
        .demob-safe {
            border-left: 4px solid var(--success);
        }
        
        .priority-critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .priority-standard {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .priority-external {
            background: rgba(156, 163, 175, 0.2);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }
        
        .match-score-high {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .match-score-medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .match-score-low {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Database Specific Styles */
        .storage-meter {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .storage-fill {
            height: 100%;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .storage-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        .contact-verified {
            color: var(--success);
        }
        
        .contact-unverified {
            color: var(--text-secondary);
        }
        
        .data-row:hover {
            background: var(--bg-hover);
        }
        
        /* Compliance Table Styles */
        .compliance-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .compliance-table th {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }
        
        .compliance-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }
        
        .compliance-pass {
            color: var(--success);
        }
        
        .compliance-fail {
            color: var(--error);
        }
        
        /* Script Styles */
        .script-header {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .script-meta {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        
        .pre-call-brief-section {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }
        
        .pre-call-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .pre-call-item {
            display: flex;
            flex-direction: column;
        }
        
        .pre-call-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .pre-call-value {
            font-size: 0.875rem;
            color: var(--text-primary);
        }
        
        .script-section {
            background: var(--bg-tertiary);
            padding: 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }
        
        .script-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 0.75rem;
        }
        
        .script-question {
            padding: 0.75rem;
            background: var(--bg-hover);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .call-notes-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }
        
        .call-notes-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        
        .call-notes-textarea {
            width: 100%;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            min-height: 120px;
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: vertical;
        }
        
        .call-notes-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }
        
        /* Email Template Styles */
        .email-template {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            font-size: 0.875rem;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        /* Duplicate Detection Styles */
        .duplicate-badge {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Responsive Grid */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
		
		/* Interest Status Styles */
.interest-status-container {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.interest-checkbox {
    display: flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
}

.interest-checkbox:hover {
    background: var(--bg-hover);
    border-color: var(--border-hover);
}

.interest-checkbox.interest-active {
    font-weight: 600;
}

.interest-checkbox.interest-positive {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    border-color: rgba(16, 185, 129, 0.3);
}

.interest-checkbox.interest-negative {
    background: rgba(239, 68, 68, 0.2);
    color: var(--error);
    border-color: rgba(239, 68, 68, 0.3);
}

.interest-checkbox.interest-neutral {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning);
    border-color: rgba(245, 158, 11, 0.3);
}

.interest-checkbox svg {
    flex-shrink: 0;
}
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold gradient-text">Initializing Command Center</h2>
            <p class="text-gray-500 mt-2">Establishing secure connection...</p>
        </div>
    </div>
    
    <!-- Auth Container -->
    <div id="auth-container" class="hidden fixed inset-0 bg-black z-40 flex items-center justify-center p-4">
        <div class="glass max-w-md w-full p-8 rounded-2xl text-center animate-in">
            <div class="mb-8">
                <h1 class="text-4xl font-bold mb-2">
                    <span class="gradient-text">Sourcing Command Center</span>
                </h1>
                <p class="text-gray-400">Secure Access Portal</p>
            </div>
            
            <div class="space-y-4">
                <button id="google-signin" class="btn btn-primary w-full flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
                
                <button id="anonymous-signin" class="btn btn-secondary w-full">
                    Continue as Guest
                </button>
            </div>
            
            <p class="text-xs text-gray-500 mt-8">
                By signing in, you agree to our secure data handling practices
            </p>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="app" class="hidden flex h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-64 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <h1 class="text-xl font-bold">
                    <span class="gradient-text">Command Center</span>
                </h1>
                <p class="text-xs text-gray-500 mt-1">v3.0 Enhanced</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-1">
                <div class="nav-item active" data-view="dashboard">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Dashboard
                </div>
                
                <div class="nav-item" data-view="database">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                    </svg>
                    CV Database
                    <span id="database-count" class="ml-auto badge badge-primary">0</span>
                </div>
                
                <div class="nav-item" data-view="candidates">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Candidates
                </div>
                
                <div class="nav-item" data-view="projects">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                    Projects
                </div>
                
                <div class="nav-item" data-view="demob">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Demob Pipeline
                    <span id="demob-count" class="ml-auto badge badge-error hidden">0</span>
                </div>
                
                <div class="nav-item" data-view="knowledge">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    Knowledge Base
                </div>
                
                <div class="nav-item" data-view="analytics">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Analytics
                </div>
                
                <div class="nav-item" data-view="configuration">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Configuration
                </div>
            </nav>
            
            <div class="p-4 border-t border-gray-800">
                <button id="config-btn" class="btn btn-secondary w-full flex items-center justify-center gap-2 mb-2">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Settings
                </button>
                
                <button id="signout-btn" class="btn-ghost w-full text-sm">
                    Sign Out
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto main-content">
            <!-- Header Bar -->
            <div id="project-selector-bar" class="header-bar">
                <div class="flex items-center gap-4">
                    <label class="text-sm text-gray-400">Active Project:</label>
                    <select id="active-project-select" class="select min-w-[200px]">
                        <option value="">Select a project...</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="status-indicator status-online"></span>
                        <span class="text-sm text-gray-400">System Active</span>
                    </div>
                    <div class="avatar">
                        <span id="user-initials">U</span>
                    </div>
                </div>
            </div>
            
            <!-- Main View Container -->
            <div id="main-view" class="p-6">
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-400">Loading...</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Hidden File Inputs -->
    <input type="file" id="file-upload-input" class="hidden" multiple accept=".pdf,.docx,.xlsx,.xls">
    <input type="file" id="knowledge-upload-input" class="hidden" multiple accept=".pdf,.docx">
    <input type="file" id="positions-upload-input" class="hidden" accept=".xlsx,.xls">
    <input type="file" id="demob-upload-input" class="hidden" accept=".xlsx,.xls">
    <input type="file" id="cv-database-input" class="hidden" multiple accept=".pdf,.docx">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Main Script -->
    <script type="module">
        // Initialize Firebase with compatibility mode
        const firebase = window.firebase;
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLXh5mJcqATfOd4wRzBCbK2-L53YDxiTM",
            authDomain: "egis-recruitpro-t36hm.firebaseapp.com",
            projectId: "egis-recruitpro-t36hm",
            storageBucket: "egis-recruitpro-t36hm.firebasestorage.app",
            messagingSenderId: "214972751213",
            appId: "1:214972751213:web:836c877aeed79f095dce64"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global State
        let userId = null;
        let userRole = 'viewer';
        let userPermissions = {};
        let currentView = 'dashboard';
        let activeProject = null;
        let projects = [];
        let candidates = [];
        let demobProfiles = [];
        let knowledgeBase = {};
        let positions = {};
        let demobMatches = [];
        let analytics = {};
        
		let candidateFilters = {
    interestStatus: 'exclude_not_interested', // 'all', 'interested', 'not_interested', 'yet_to_decide', 'exclude_not_interested'
    emailSent: 'all', // 'all', 'sent', 'not_sent'
    searchText: ''
};
let filteredCandidates = [];
        // Database-specific state
        let databaseCandidates = [];
        let filteredDatabaseCandidates = [];
        let currentDatabasePage = 1;
        let databasePageSize = 25;
        let totalStorageUsed = 0;
        let maxStorage = 100 * 1024 * 1024; // 100MB limit
        let processingTimes = [];
        // Enhanced error tracking and monitoring
let processingStats = {
    totalProcessed: 0,
    totalFailed: 0,
    batchesProcessed: 0,
    individualProcessed: 0,
    averageProcessingTime: 0,
    apiCallsMade: 0,
    costSavings: 0
};
        // File size limits (in bytes)
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const WARNING_FILE_SIZE = 2 * 1024 * 1024; // 2MB
		// Batch processing configuration
const BATCH_SIZE = 5; // Max files per batch
const MIN_BATCH_SIZE = 3; // Minimum files to trigger batch
const BATCH_TIMEOUT = 10000; // 10 seconds timeout for batch collection

// Processing queue and state
let processingQueue = [];
let isProcessing = false;
let processingTimer = null;
let forceProcessingMode = 'auto'; // 'auto', 'batch', 'individual'
        
        // Unsubscribe functions
        let unsubscribes = {
            projects: null,
            candidates: null,
            knowledge: null,
            positions: null,
            demob: null,
            matches: null,
            database: null
        };
        
        // API Configuration
        const API_BASE_URL = 'https://us-central1-egis-recruitpro-t36hm.cloudfunctions.net';
        
        // Set up pdfjsLib worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        }
        
        // --- HELPER FUNCTIONS ---
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification
			notification.className = `notification notification-${type} animate-in`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function validatePhone(phone) {
            const re = /^[\+]?[\d\s\-\(\)]{10,}$/;
            return re.test(phone.replace(/\s/g, ''));
        }

// Gemini 2 API helper function
async function callGemini2API(prompt, apiKey, config = {}) {
    const {
        temperature = 0.3,
        maxOutputTokens = 8192,
        topP = 0.95
    } = config;
    
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    temperature: temperature,
                    maxOutputTokens: maxOutputTokens,
                    topP: topP
                }
            })
        });
        
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`Gemini API error: ${error}`);
        }
        
        const result = await response.json();
        return JSON.parse(result.candidates[0].content.parts[0].text);
    } catch (error) {
        console.error('Gemini 2 API call failed:', error);
        throw error;
    }
}


        // Add these functions before the extractContactInfo function:
const API_RATE_LIMIT = 60; // calls per minute
let apiCallTimestamps = [];

async function throttledAPICall(apiFunction, ...args) {
    const now = Date.now();
    const oneMinuteAgo = now - 60000;
    
    // Clean old timestamps
    apiCallTimestamps = apiCallTimestamps.filter(ts => ts > oneMinuteAgo);
    
    // Check rate limit
    if (apiCallTimestamps.length >= API_RATE_LIMIT) {
        const oldestCall = apiCallTimestamps[0];
        const waitTime = 60000 - (now - oldestCall);
        await new Promise(resolve => setTimeout(resolve, waitTime));
    }
    
    apiCallTimestamps.push(now);
    return await apiFunction(...args);
}

async function checkNetworkConnectivity() {
    try {
        const response = await fetch('https://www.google.com/favicon.ico', {
            mode: 'no-cors',
            cache: 'no-cache'
        });
        return true;
    } catch (error) {
        return false;
    }
}

async function retryFailedProcessing(file, maxRetries = 3) {
    let retries = 0;
    let delay = 1000; // Start with 1 second
    
    while (retries < maxRetries) {
        try {
            const isOnline = await checkNetworkConnectivity();
            if (!isOnline) {
                throw new Error('No network connectivity');
            }
            
            return await processIndividualCV(file);
        } catch (error) {
            retries++;
            if (retries >= maxRetries) throw error;
            
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // Exponential backoff
        }
    }
}


// Then the existing extractContactInfo function follows:
function extractContactInfo(text) {
    const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g;
    const phoneRegex = /(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/g;
    
    const emails = text.match(emailRegex) || [];
    const phones = text.match(phoneRegex) || [];
    
    return {
        emails: [...new Set(emails)].slice(0, 3),
        phones: [...new Set(phones)].slice(0, 3)
    };
}
		// Batch processing for database
async function processBatchWithSingleAPI(batchContents, apiKey) {
    const combinedPrompt = `
You are RecruitPro Database AI. Analyze multiple CVs in a single batch and extract structured information.

TASK: Process ${batchContents.length} CVs and return structured data for each.

${batchContents.map((item, index) => `
========== CV ${index + 1}: ${item.fileName} ==========
${item.content.substring(0, 2000)}
`).join('\n\n')}

Generate a JSON response with this EXACT structure:
{
    "batch_results": [
        ${batchContents.map((_, index) => `{
            "file_index": ${index},
            "candidate_profile": {
                "personal_info": {
                    "full_name": "Complete name",
                    "email": "Email address",
                    "phone": "Phone number",
                    "location": "Location",
                    "linkedin_url": "LinkedIn URL if found",
                    "nationality": "Nationality if mentioned"
                },
                "professional_summary": {
                    "current_position": "Current job title",
                    "total_experience_years": 0,
                    "industry": "Industry/sector",
                    "summary": "Brief summary (max 200 chars)"
                },
                "skills": {
                    "technical_skills": ["List of technical skills"],
                    "soft_skills": ["Soft skills"],
                    "certifications": ["Certifications"],
                    "languages": ["Languages with proficiency"]
                },
                "experience": [
                    {
                        "company": "Company name",
                        "position": "Job title",
                        "duration": "Duration",
                        "location": "Location",
                        "key_achievements": ["Achievements"]
                    }
                ],
                "education": [
                    {
                        "institution": "University/School",
                        "degree": "Degree",
                        "field": "Field of study",
                        "year": "Year",
                        "location": "Location"
                    }
                ],
                "contact_verification": {
                    "email_confidence": "high|medium|low",
                    "phone_confidence": "high|medium|low",
                    "location_confidence": "high|medium|low"
                },
                "keywords": ["Search keywords"],
                "availability": {
                    "notice_period": "Notice period",
                    "preferred_location": "Preferred location",
                    "salary_expectation": "Salary expectation"
                }
            }
        }`).join(',\n')}
    ]
}

IMPORTANT: Extract actual information from each CV. If information is not available, use null or empty array.`;

    const responseText = await callGemini2API(combinedPrompt, apiKey, {
        temperature: 0.3,
        maxOutputTokens: 30000,
        topP: 0.8
    });
    
    return responseText;
}
// Save batch results to database
async function saveBatchResults(batchAnalysis, successfulExtractions) {
    const results = batchAnalysis.batch_results || [];
    const savedIds = [];
    
    for (const result of results) {
        const extraction = successfulExtractions[result.file_index];
        if (!extraction) continue;
        
        const candidateData = {
            candidate_profile: result.candidate_profile
        };
        
        // Check for duplicates
        const duplicate = await checkDuplicateCV(candidateData);
        if (duplicate) {
            console.log(`Duplicate found for ${extraction.fileName}, skipping...`);
            continue;
        }
        
        // Save to database
        const savedId = await saveCandidateToDatabase(
            candidateData, 
            extraction.fileName, 
            extraction.size
        );
        
        if (savedId) {
            savedIds.push(savedId);
        }
    }
    
    return savedIds;
}

// Process individual CV (fallback)
async function processIndividualCV(file) {
    const apiKey = localStorage.getItem('gemini_api_key');
    if (!apiKey) throw new Error('API key not configured');
    
    let content = '';
    if (file.type === 'application/pdf') {
        content = await readPdfFile(file);
    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
               file.name.toLowerCase().endsWith('.docx')) {
        content = await readDocxFile(file);
    } else {
        throw new Error('Unsupported file type');
    }
    
    const analysis = await processWithDatabaseAI(content, apiKey, file.name);
    const savedId = await saveCandidateToDatabase(analysis, file.name, file.size);
    
    return savedId;
}

        function getDaysUntilDemob(demobDate) {
            if (!demobDate) return null;
			const today = new Date();
            const demob = new Date(demobDate);
            const diffTime = demob - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
		// Enhanced knowledge context builder
function buildEnhancedKnowledgeContext(project, knowledgeDocs, positions) {
    const projectInfo = knowledgeDocs
        .map(doc => doc.extractedText || '')
        .join('\n\n')
        .substring(0, 3000); // Limit context size
    
    const jobDescriptions = positions.map(p => `
Position: ${p.title}
Description: ${p.description}
Required Skills: ${(p.required_skills || []).join(', ')}
Location: ${p.location || 'Not specified'}
Start Date: ${p.start_date || 'ASAP'}
Project Type: ${p.project_type || 'Not specified'}
`).join('\n\n');
    
    return {
        projectInfo,
        jobDescriptions
    };
}
		
		
        function getUrgencyClass(days) {
            if (days <= 30) return 'demob-urgent';
            if (days <= 90) return 'demob-warning';
            return 'demob-safe';
        }
        
        function getMatchScoreClass(score) {
            if (score >= 85) return 'match-score-high';
            if (score >= 70) return 'match-score-medium';
            return 'match-score-low';
        }
        
        // --- DATABASE SPECIFIC FUNCTIONS ---
        
        // Enhanced AI Processing with Contact Extraction for Database
       async function processWithDatabaseAI(content, apiKey, fileName) {
    const prompt = `
    You are RecruitPro Database AI, specialized in extracting structured candidate information from CVs for database storage.
    
    TASK: Extract comprehensive candidate information from the CV content below and format it as structured JSON.
    
    CV CONTENT:
    ${content}
    
    Generate a JSON response with this EXACT structure:
    
    {
        "candidate_profile": {
            "personal_info": {
                "full_name": "Complete name of the candidate",
                "email": "Primary email address",
                "phone": "Primary phone number",
                "location": "Current location/city/country",
                "linkedin_url": "LinkedIn profile URL if mentioned",
                "nationality": "Nationality if mentioned"
            },
            "professional_summary": {
                "current_position": "Current job title",
                "total_experience_years": 0,
                "industry": "Primary industry/sector",
                "summary": "Brief professional summary (max 200 chars)"
            },
            "skills": {
                "technical_skills": ["List of technical skills"],
                "soft_skills": ["List of soft skills"],
                "certifications": ["Professional certifications"],
                "languages": ["Languages spoken with proficiency level"]
            },
            "experience": [
                {
                    "company": "Company name",
                    "position": "Job title",
                    "duration": "Duration in job",
                    "location": "Job location",
                    "key_achievements": ["Top 2-3 achievements"]
                }
            ],
            "education": [
                {
                    "institution": "University/School name",
                    "degree": "Degree/Qualification",
                    "field": "Field of study",
                    "year": "Graduation year",
                    "location": "Institution location"
                }
            ],
            "contact_verification": {
                "email_confidence": "high|medium|low",
                "phone_confidence": "high|medium|low",
                "location_confidence": "high|medium|low"
            },
            "keywords": ["Relevant keywords for search"],
            "availability": {
                "notice_period": "Notice period if mentioned",
                "preferred_location": "Preferred work location",
                "salary_expectation": "Salary expectation if mentioned"
            }
        }
    }
    
    IMPORTANT INSTRUCTIONS:
    - Extract actual information from the CV content, don't make assumptions
    - For experience years, calculate based on work history
    - Include only verified contact information you can find in the text
    - Keep summaries concise to optimize storage
    - If information is not available, use null or empty array
    - Prioritize accuracy over completeness
    `;
    
    return await callGemini2API(prompt, apiKey, {
        temperature: 0.3,
        maxOutputTokens: 8192
    });
}
        
        // File reading utilities
        async function readPdfFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                
                // Limit pages to control processing time and storage
                const maxPages = Math.min(pdf.numPages, 10);
                
                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                    
                    // Break if we have enough content (to save processing time)
                    if (fullText.length > 10000) break;
                }
                
                return fullText;
            } catch (error) {
                console.error('PDF reading error:', error);
                throw new Error('Failed to read PDF file');
            }
        }
        
        async function readDocxFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const text = new TextDecoder().decode(arrayBuffer);
                // This is simplified - in production, use mammoth.js for proper DOCX parsing
                return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim().substring(0, 10000);
            } catch (error) {
                console.error('DOCX reading error:', error);
                throw new Error('Failed to read DOCX file');
            }
        }
        
        async function readExcelFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                return XLSX.utils.sheet_to_json(firstSheet);
            } catch (error) {
                console.error('Excel reading error:', error);
                throw new Error('Failed to read Excel file');
            }
        }
        
        async function readExcelAsText(file) {
            const data = await readExcelFile(file);
            return JSON.stringify(data, null, 2);
        }
        
        // Check for duplicate CVs
        async function checkDuplicateCV(candidateData) {
            const profile = candidateData.candidate_profile;
            if (!profile?.personal_info) return null;
            
            // Check by email
            if (profile.personal_info.email) {
                const emailQuery = await db.collection('cv_database')
                    .where('candidate_profile.personal_info.email', '==', profile.personal_info.email)
                    .limit(1)
                    .get();
                
                if (!emailQuery.empty) {
                    return emailQuery.docs[0];
                }
            }
            
            // Check by phone
            if (profile.personal_info.phone) {
                const phoneQuery = await db.collection('cv_database')
                    .where('candidate_profile.personal_info.phone', '==', profile.personal_info.phone)
                    .limit(1)
                    .get();
                
                if (!phoneQuery.empty) {
                    return phoneQuery.docs[0];
                }
            }
            
            // Check by name (exact match)
            if (profile.personal_info.full_name) {
                const nameQuery = await db.collection('cv_database')
                    .where('candidate_profile.personal_info.full_name', '==', profile.personal_info.full_name)
                    .limit(1)
                    .get();
                
                if (!nameQuery.empty) {
                    return nameQuery.docs[0];
                }
            }
            
            return null;
        }
        
        // Database Operations
        async function saveCandidateToDatabase(candidateData, fileName, fileSize) {
            try {
                const userId = auth.currentUser?.uid || 'anonymous';
                
                // Check for duplicates
                const duplicate = await checkDuplicateCV(candidateData);
                if (duplicate) {
                    const duplicateData = duplicate.data();
                    const duplicateName = duplicateData.candidate_profile?.personal_info?.full_name || 'Unknown';
                    
                    if (!confirm(`A candidate profile for "${duplicateName}" already exists in the database. Do you want to update it?`)) {
                        return null;
                    }
                    
                    // Update existing record
                    const updateData = {
                        ...candidateData,
                        metadata: {
                            ...candidateData.metadata,
                            source_file: fileName,
                            file_size: fileSize,
                            last_updated: firebase.firestore.FieldValue.serverTimestamp(),
                            updated_by: userId,
                            update_count: firebase.firestore.FieldValue.increment(1)
                        },
                        search_index: generateSearchIndex(candidateData),
                        storage_optimized: true
                    };
                    
                    await duplicate.ref.update(updateData);
                    showNotification(`Updated existing profile for ${duplicateName}`, 'info');
                    return duplicate.id;
                }
                
                // Add new record
                const dbRecord = {
                    ...candidateData,
                    metadata: {
                        source_file: fileName,
                        file_size: fileSize,
                        processing_date: firebase.firestore.FieldValue.serverTimestamp(),
                        processed_by: userId,
                        version: '1.0',
                        update_count: 0
                    },
                    search_index: generateSearchIndex(candidateData),
                    storage_optimized: true
                };
                
                const docRef = await db.collection('cv_database').add(dbRecord);
                
                // Update storage tracking
                totalStorageUsed += fileSize;
                updateStorageDisplay();
                
                return docRef.id;
            } catch (error) {
                console.error('Database save error:', error);
                throw error;
            }
        }
        
        function generateSearchIndex(candidateData) {
            const profile = candidateData.candidate_profile;
            const searchTerms = [];
            
            // Add name variations
            if (profile.personal_info?.full_name) {
                searchTerms.push(profile.personal_info.full_name.toLowerCase());
                const nameParts = profile.personal_info.full_name.split(' ');
                searchTerms.push(...nameParts.map(part => part.toLowerCase()));
            }
            
            // Add contact info
            if (profile.personal_info?.email) {
                searchTerms.push(profile.personal_info.email.toLowerCase());
            }
            if (profile.personal_info?.phone) {
                searchTerms.push(profile.personal_info.phone.replace(/\D/g, ''));
            }
            
            // Add skills
            if (profile.skills?.technical_skills) {
                searchTerms.push(...profile.skills.technical_skills.map(skill => skill.toLowerCase()));
            }
            
            // Add company names
            if (profile.experience) {
                profile.experience.forEach(exp => {
                    if (exp.company) searchTerms.push(exp.company.toLowerCase());
                    if (exp.position) searchTerms.push(exp.position.toLowerCase());
                });
            }
            
            // Add location
            if (profile.personal_info?.location) {
                searchTerms.push(profile.personal_info.location.toLowerCase());
            }
            
            return [...new Set(searchTerms)]; // Remove duplicates
        }
        
        // File Upload Processing for Database
        // Enhanced file upload processing with batch capability
async function processDatabaseFiles(files) {
    const apiKey = localStorage.getItem('gemini_api_key');
    if (!apiKey) {
        showNotification('Please configure your Gemini API key in settings', 'error');
        return;
    }
    
    // Validate files
    let validFiles = [];
    let oversizedFiles = [];
    
    for (const file of files) {
        if (file.size > MAX_FILE_SIZE) {
            oversizedFiles.push(file.name);
        } else {
            validFiles.push(file);
        }
    }
    
    if (oversizedFiles.length > 0) {
        showNotification(`Files too large (>5MB): ${oversizedFiles.join(', ')}`, 'error');
    }
    
    if (validFiles.length === 0) return;
    
    // Check if we should use batch processing
    if (validFiles.length >= MIN_BATCH_SIZE && forceProcessingMode !== 'individual') {
        // Use batch processing
        await processBatchCVs(validFiles, BATCH_SIZE);
    } else {
        // Process individually for small number of files
        await processFilesIndividually(validFiles);
    }
}

// Process files individually
async function processFilesIndividually(files) {
    showLoading(true);
    
    let processed = 0;
    let failed = 0;
    const startTime = Date.now();
    
    for (const file of files) {
        try {
            await processIndividualCV(file);
            processed++;
            processingStats.individualProcessed++;
            processingStats.totalProcessed++;
            showNotification(`Processed: ${file.name}`, 'success');
        } catch (error) {
            console.error('File processing error:', error);
            showNotification(`Failed: ${file.name}`, 'error');
            failed++;
            processingStats.totalFailed++;
        }
    }
    
    const processingTime = Date.now() - startTime;
    processingTimes.push(processingTime);
    
    showLoading(false);
    
    const summary = `Processing complete: ${processed} successful${failed > 0 ? `, ${failed} failed` : ''}`;
    showNotification(summary, processed > 0 ? 'success' : 'error');
    
    if (currentView === 'database') {
        await loadDatabaseCandidates();
        updateDatabaseStatistics();
    }
}

// Enhanced batch processing
async function processBatchCVs(files, batchSize = 5) {
    const apiKey = localStorage.getItem('gemini_api_key');
    if (!apiKey) {
        showNotification('Please configure your Gemini API key in settings', 'error');
        return;
    }
    
    showLoading(true);
    const startTime = Date.now();
    
    try {
        // Group files into batches
        const batches = [];
        for (let i = 0; i < files.length; i += batchSize) {
            batches.push(files.slice(i, i + batchSize));
        }
        
        let totalProcessed = 0;
        let totalFailed = 0;
        let totalApiCalls = 0;
        
        for (const batch of batches) {
            try {
                // Process batch content extraction in parallel
                const batchContents = await Promise.all(
                    batch.map(async (file) => {
                        let content = '';
                        try {
                            if (file.type === 'application/pdf') {
                                content = await readPdfFile(file);
                            } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                                       file.name.toLowerCase().endsWith('.docx')) {
                                content = await readDocxFile(file);
                            }
                            return {
                                fileName: file.name,
                                content: content,
                                size: file.size,
                                success: true
                            };
                        } catch (error) {
                            return {
                                fileName: file.name,
                                content: '',
                                size: file.size,
                                success: false,
                                error: error.message
                            };
                        }
                    })
                );
                
                // Filter successful extractions
                const successfulExtractions = batchContents.filter(item => item.success && item.content.length > 100);
                
                if (successfulExtractions.length > 0) {
                    // Process batch with single API call
                    const batchAnalysis = await processBatchWithSingleAPI(successfulExtractions, apiKey);
                    totalApiCalls++;
                    processingStats.apiCallsMade++;
                    
                    // Save results to database
                    await saveBatchResults(batchAnalysis, successfulExtractions);
                    
                    totalProcessed += successfulExtractions.length;
                    processingStats.batchesProcessed += successfulExtractions.length;
                    processingStats.totalProcessed += successfulExtractions.length;
                    showNotification(`Batch processed: ${successfulExtractions.length} CVs`, 'success');
                }
                
                totalFailed += batchContents.filter(item => !item.success).length;
                processingStats.totalFailed += batchContents.filter(item => !item.success).length;
                
                // Add delay between batches
                if (batches.indexOf(batch) < batches.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
            } catch (error) {
                console.error('Batch processing error:', error);
                totalFailed += batch.length;
                processingStats.totalFailed += batch.length;
            }
        }
        
        const processingTime = Date.now() - startTime;
        processingTimes.push(processingTime);
        
        // Track statistics
        processingStats.costSavings += (totalProcessed - totalApiCalls);
        processingStats.averageProcessingTime = 
            (processingStats.averageProcessingTime + processingTime) / 2;
        
        let summaryMessage = `Batch processing complete: ${totalProcessed} successful`;
        if (totalFailed > 0) summaryMessage += `, ${totalFailed} failed`;
        if (totalApiCalls > 0) {
            const savings = totalProcessed - totalApiCalls;
            summaryMessage += ` (Saved ${savings} API calls)`;
        }
        
        showNotification(summaryMessage, totalFailed === 0 ? 'success' : 'warning');
        
    } finally {
        showLoading(false);
        
        if (currentView === 'database') {
            await loadDatabaseCandidates();
            updateDatabaseStatistics();
        }
    }
}
        
// Process multiple CVs in a single API call
async function processBatchWithSingleAPI(cvBatch, apiKey) {
    const projectKnowledge = knowledgeBase[activeProject?.id] || [];
    const projectPositions = positions[activeProject?.id] || [];
    
    // Build context (same as individual processing)
    const knowledgeContext = buildEnhancedKnowledgeContext(activeProject, projectKnowledge, projectPositions);
    
    // Create batch prompt
    const batchPrompt = `
You are RecruitPro Database AI, specialized in processing multiple candidate CVs efficiently in a single operation.

PROJECT CONTEXT:
${activeProject ? `Project Name: ${activeProject.projectName}` : 'Database Storage Mode'}

${knowledgeContext.jobDescriptions ? `Available Positions:\n${knowledgeContext.jobDescriptions}` : ''}

TASK: Process the following ${cvBatch.length} CVs and generate structured candidate profiles for database storage.

CANDIDATE DATA:
${cvBatch.map((cv, index) => `
=== CANDIDATE ${index + 1}: ${cv.fileName} ===
${cv.content}
`).join('\n\n')}

Generate a JSON response with this EXACT structure:

{
    "batch_results": [
        {
            "candidate_index": 0,
            "source_file": "${cvBatch[0]?.fileName}",
            "candidate_profile": {
                "personal_info": {
                    "full_name": "Complete name of the candidate",
                    "email": "Primary email address",
                    "phone": "Primary phone number",
                    "location": "Current location/city/country",
                    "linkedin_url": "LinkedIn profile URL if mentioned",
                    "nationality": "Nationality if mentioned"
                },
                "professional_summary": {
                    "current_position": "Current job title",
                    "total_experience_years": 0,
                    "industry": "Primary industry/sector",
                    "summary": "Brief professional summary (max 200 chars)"
                },
                "skills": {
                    "technical_skills": ["List of technical skills"],
                    "soft_skills": ["List of soft skills"],
                    "certifications": ["Professional certifications"],
                    "languages": ["Languages spoken with proficiency level"]
                },
                "experience": [
                    {
                        "company": "Company name",
                        "position": "Job title",
                        "duration": "Duration in job",
                        "location": "Job location",
                        "key_achievements": ["Top 2-3 achievements"]
                    }
                ],
                "education": [
                    {
                        "institution": "University/School name",
                        "degree": "Degree/Qualification",
                        "field": "Field of study",
                        "year": "Graduation year",
                        "location": "Institution location"
                    }
                ],
                "contact_verification": {
                    "email_confidence": "high|medium|low",
                    "phone_confidence": "high|medium|low",
                    "location_confidence": "high|medium|low"
                },
                "keywords": ["Relevant keywords for search"],
                "availability": {
                    "notice_period": "Notice period if mentioned",
                    "preferred_location": "Preferred work location",
                    "salary_expectation": "Salary expectation if mentioned"
                }
            }
        }
    ]
}

IMPORTANT:
- Process each CV separately in the batch_results array
- candidate_index should match the order in the input (0, 1, 2, etc.)
- Extract actual information from each CV, don't make assumptions
- If CV content is unclear or corrupted, still provide a profile with available information
- Ensure all ${cvBatch.length} candidates are processed
`;

    try {
        const responseText = await callGemini2API(batchPrompt, apiKey, {
            temperature: 0.2, // Lower temperature for batch processing
            maxOutputTokens: 30000, // Higher limit for batch processing
            topP: 0.8
        });
        
        return responseText.batch_results || [];
        
    } catch (error) {
        console.error('Batch API processing error:', error);
        // Fallback to individual processing
        return await fallbackToIndividualProcessing(cvBatch, apiKey);
    }
}
// Fallback to individual processing if batch fails
async function fallbackToIndividualProcessing(cvBatch, apiKey) {
    console.log('Falling back to individual CV processing');
    const results = [];
    
    for (const cv of cvBatch) {
        try {
            const analysis = await processWithDatabaseAI(cv.content, apiKey, cv.fileName);
            results.push({
                candidate_index: cvBatch.indexOf(cv),
                source_file: cv.fileName,
                candidate_profile: analysis.candidate_profile
            });
        } catch (error) {
            console.error(`Failed to process ${cv.fileName}:`, error);
            // Add placeholder entry
            results.push({
                candidate_index: cvBatch.indexOf(cv),
                source_file: cv.fileName,
                candidate_profile: {
                    personal_info: { full_name: "Processing Failed" },
                    processing_error: error.message
                }
            });
        }
    }
    
    return results;
}
// Save batch processing results to database
async function saveBatchResults(batchAnalysis, cvBatch) {
    const userId = auth.currentUser?.uid || 'anonymous';
    let batch = db.batch();
    let operationCount = 0;
    const maxBatchSize = 500;
    
    for (const result of batchAnalysis) {
        try {
            const cvData = cvBatch[result.candidate_index];
            
            // Check for duplicates
            const duplicate = await checkDuplicateCV(result);
            
            if (!duplicate) {
                const dbRecord = {
                    candidate_profile: result.candidate_profile,
                    metadata: {
                        source_file: result.source_file,
                        file_size: cvData.size,
                        processing_date: firebase.firestore.FieldValue.serverTimestamp(),
                        processed_by: userId,
                        version: '1.0',
                        batch_processed: true,
                        batch_size: batchAnalysis.length
                    },
                    search_index: generateSearchIndex(result),
                    storage_optimized: true
                };
                
                const docRef = db.collection('cv_database').doc();
                batch.set(docRef, dbRecord);
                operationCount++;
                
                // Commit batch if reaching limit
                if (operationCount >= maxBatchSize) {
                    await batch.commit();
                    batch = db.batch();
                    operationCount = 0;
                }
            }
            
        } catch (error) {
            console.error('Error saving batch result:', error);
        }
    }
    
    // Commit any remaining operations
    if (operationCount > 0) {
        await batch.commit();
    }
}
        // Database Loading
        async function loadDatabaseCandidates() {
            try {
                const snapshot = await db.collection('cv_database')
                    .orderBy('metadata.processing_date', 'desc')
                    .limit(1000)
                    .get();
                
                databaseCandidates = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                filteredDatabaseCandidates = [...databaseCandidates];
                renderDatabaseView();
                
                // Update database count in sidebar
                const countEl = document.getElementById('database-count');
                if (countEl) {
                    countEl.textContent = databaseCandidates.length;
                }
                
            } catch (error) {
                console.error('Database loading error:', error);
                showNotification('Failed to load candidates from database', 'error');
            }
        }
        
        // Storage Management
        function updateStorageDisplay() {
            const percentage = (totalStorageUsed / maxStorage) * 100;
            const storagePercentageEl = document.getElementById('storage-percentage');
            const storageUsedEl = document.getElementById('storage-used');
            const storageTotalEl = document.getElementById('storage-total');
            const storageFillEl = document.getElementById('storage-fill');
            
            if (storagePercentageEl) storagePercentageEl.textContent = `${percentage.toFixed(1)}%`;
            if (storageUsedEl) storageUsedEl.textContent = formatFileSize(totalStorageUsed);
            if (storageTotalEl) storageTotalEl.textContent = formatFileSize(maxStorage);
            
            if (storageFillEl) {
                storageFillEl.style.width = `${percentage}%`;
                
                // Change color based on usage
                if (percentage > 90) {
                    storageFillEl.className = 'storage-fill bg-red-500';
                } else if (percentage > 70) {
                    storageFillEl.className = 'storage-fill bg-yellow-500';
                } else {
                    storageFillEl.className = 'storage-fill bg-gradient-to-r from-cyan-500 to-blue-500';
                }
            }
            
            // Trigger cleanup if storage exceeds 80%
            if (percentage > 80) {
                triggerStorageCleanup();
            }
        }
        
        // Database Statistics Update
        function updateDatabaseStatistics() {
            // Total profiles
            const totalProfilesEl = document.getElementById('total-profiles');
            if (totalProfilesEl) totalProfilesEl.textContent = databaseCandidates.length;
            
            // Verified contacts
            const verifiedCount = databaseCandidates.filter(candidate => {
                const personal = candidate.candidate_profile?.personal_info || {};
                return validateEmail(personal.email) && validatePhone(personal.phone);
            }).length;
            const verifiedContactsEl = document.getElementById('verified-contacts');
            if (verifiedContactsEl) verifiedContactsEl.textContent = verifiedCount;
            
            // Monthly uploads
            const thisMonth = new Date();
            thisMonth.setDate(1);
            const monthlyCount = databaseCandidates.filter(candidate => {
                const processDate = candidate.metadata?.processing_date?.toDate();
                return processDate && processDate >= thisMonth;
            }).length;
            const monthlyUploadsEl = document.getElementById('monthly-uploads');
            if (monthlyUploadsEl) monthlyUploadsEl.textContent = monthlyCount;
            
            // Average processing time
            const avgTime = processingTimes.length > 0 ? 
                processingTimes.reduce((a, b) => a + b) / processingTimes.length / 1000 : 0;
            const avgProcessingTimeEl = document.getElementById('avg-processing-time');
            if (avgProcessingTimeEl) avgProcessingTimeEl.textContent = `${avgTime.toFixed(1)}s`;
        }
        
        // Automatic Storage Cleanup
        async function triggerStorageCleanup() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const oldRecords = databaseCandidates.filter(candidate => {
                const processDate = candidate.metadata?.processing_date?.toDate();
                return processDate && processDate < thirtyDaysAgo;
            });
            
            if (oldRecords.length > 0) {
                showNotification(`Storage cleanup: Found ${oldRecords.length} records older than 30 days`, 'warning');
                // In production, implement actual deletion logic here
            }
        }
        
        // Search and Filter Functions
        function searchDatabase(searchTerm) {
            if (!searchTerm) {
                filteredDatabaseCandidates = [...databaseCandidates];
            } else {
                const term = searchTerm.toLowerCase();
                filteredDatabaseCandidates = databaseCandidates.filter(candidate => {
                    const searchIndex = candidate.search_index || [];
                    return searchIndex.some(index => index.includes(term));
                });
            }
            
            currentDatabasePage = 1;
            renderDatabaseTable();
        }
        
        function filterDatabaseBySkills(skills) {
            if (!skills || skills.length === 0) {
                filteredDatabaseCandidates = [...databaseCandidates];
            } else {
                filteredDatabaseCandidates = databaseCandidates.filter(candidate => {
                    const candidateSkills = candidate.candidate_profile?.skills?.technical_skills || [];
                    return skills.some(skill => 
                        candidateSkills.some(cs => cs.toLowerCase().includes(skill.toLowerCase()))
                    );
                });
            }
            
            currentDatabasePage = 1;
            renderDatabaseTable();
        }
		// Enhanced database filtering by location
window.filterDatabaseByLocation = (location) => {
    if (!location) {
        filteredDatabaseCandidates = [...databaseCandidates];
    } else {
        filteredDatabaseCandidates = databaseCandidates.filter(candidate => {
            const candidateLocation = candidate.candidate_profile?.personal_info?.location || '';
            
            // Map location shortcuts to full names
            const locationMap = {
                'usa': ['united states', 'usa', 'us', 'america'],
                'canada': ['canada', 'ca'],
                'uk': ['united kingdom', 'uk', 'britain', 'england'],
                'uae': ['uae', 'united arab emirates', 'dubai', 'abu dhabi'],
                'australia': ['australia', 'au'],
                'india': ['india', 'in'],
                'singapore': ['singapore', 'sg'],
                'other': true // Special case for other
            };
            
            if (location === 'other') {
                // Check if location doesn't match any of the main countries
                const mainLocations = ['usa', 'canada', 'uk', 'uae', 'australia', 'india', 'singapore'];
                return !mainLocations.some(loc => 
                    locationMap[loc]?.some(variant => 
                        candidateLocation.toLowerCase().includes(variant)
                    )
                );
            }
            
            return locationMap[location]?.some(variant => 
                candidateLocation.toLowerCase().includes(variant)
            ) || false;
        });
    }
    
    currentDatabasePage = 1;
    renderDatabaseTable();
};
        
        // Export Functions
        async function exportDatabaseToCSV() {
            const csvHeaders = [
                'Name',
                'Email',
                'Phone',
                'Location',
                'Current Position',
                'Experience Years',
                'Technical Skills',
                'Education',
                'Notice Period',
                'Processing Date'
            ];
            
            const csvRows = filteredDatabaseCandidates.map(candidate => {
                const profile = candidate.candidate_profile || {};
                const personal = profile.personal_info || {};
                const professional = profile.professional_summary || {};
                
                return [
                    personal.full_name || '',
                    personal.email || '',
                    personal.phone || '',
                    personal.location || '',
                    professional.current_position || '',
                    professional.total_experience_years || '',
                    (profile.skills?.technical_skills || []).join('; '),
                    (profile.education?.[0] ? `${profile.education[0].degree} - ${profile.education[0].institution}` : ''),
                    profile.availability?.notice_period || '',
                    formatDate(candidate.metadata?.processing_date?.toDate())
                ];
            });
            
            const csv = [csvHeaders, ...csvRows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cv_database_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Database exported successfully', 'success');
        }
        
        // Delete functions
        window.deleteDatabaseCandidate = async (candidateId) => {
            if (!confirm('Are you sure you want to permanently delete this candidate from the database?')) return;
            
            try {
                await db.collection('cv_database').doc(candidateId).delete();
                
                // Update local state
                databaseCandidates = databaseCandidates.filter(c => c.id !== candidateId);
                filteredDatabaseCandidates = filteredDatabaseCandidates.filter(c => c.id !== candidateId);
                
                // Update storage
                const deletedCandidate = databaseCandidates.find(c => c.id === candidateId);
                if (deletedCandidate?.metadata?.file_size) {
                    totalStorageUsed -= deletedCandidate.metadata.file_size;
                    updateStorageDisplay();
                }
                
                renderDatabaseTable();
                showNotification('Candidate deleted successfully', 'success');
                
            } catch (error) {
                showNotification('Failed to delete candidate: ' + error.message, 'error');
            }
        };
        
        // --- AUTH FUNCTIONS ---
        
        async function handleGoogleSignIn() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showNotification('Signed in successfully!', 'success');
            } catch (error) {
                showNotification('Sign in failed: ' + error.message, 'error');
            }
        }
        
        async function handleAnonymousSignIn() {
            try {
                await auth.signInAnonymously();
                showNotification('Signed in as guest', 'success');
            } catch (error) {
                showNotification('Sign in failed: ' + error.message, 'error');
            }
        }
        
        async function handleSignOut() {
            try {
                await auth.signOut();
                showNotification('Signed out successfully', 'success');
            } catch (error) {
                showNotification('Sign out failed: ' + error.message, 'error');
            }
        }
        
        // --- EXISTING FUNCTIONS (Keeping all original functionality) ---
        
        async function getAuthToken() {
            const user = auth.currentUser;
            if (!user) throw new Error('Not authenticated');
            return await user.getIdToken();
        }
        
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const token = await getAuthToken();
                const options = {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API request failed');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }
        
        // --- PERMISSION FUNCTIONS ---
        
        async function loadUserPermissions() {
            try {
                const result = await apiCall('getUserPermissions');
                userRole = result.role;
                userPermissions = result.permissions;
                updateUIBasedOnPermissions();
            } catch (error) {
                console.error('Failed to load permissions:', error);
                // Default to viewer permissions
                userRole = 'viewer';
                userPermissions = {
                    view_candidates: true,
                    edit_candidates: false,
                    view_demob: false,
                    edit_demob: false,
                    view_analytics: false,
                    manage_users: false
                };
                updateUIBasedOnPermissions();
            }
        }
        
        function updateUIBasedOnPermissions() {
            // Show/hide navigation items based on permissions
            const demobEl = document.querySelector('[data-view="demob"]');
            const analyticsEl = document.querySelector('[data-view="analytics"]');
            
            if (demobEl) demobEl.style.display = userPermissions.view_demob ? 'flex' : 'none';
            if (analyticsEl) analyticsEl.style.display = userPermissions.view_analytics ? 'flex' : 'none';
            
            // Update current view if needed
            if (currentView === 'demob' && !userPermissions.view_demob) {
                switchView('dashboard');
            }
            if (currentView === 'analytics' && !userPermissions.view_analytics) {
                switchView('dashboard');
            }
        }
        
        // --- DATA LISTENERS ---
        
        function setupProjectsListener() {
            if (unsubscribes.projects) unsubscribes.projects();
            
            const projectsRef = db.collection(`users/${userId}/projects`);
            unsubscribes.projects = projectsRef.onSnapshot(
                (snapshot) => {
                    projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateProjectSelector();
                    
                    // Setup listeners for each project's data
                    projects.forEach(project => {
                        setupKnowledgeListener(project.id);
                        setupPositionsListener(project.id);
                    });
                    
                    // Load active project
                    if (!activeProject && projects.length > 0) {
                        const savedProjectId = localStorage.getItem('activeProjectId');
                        if (savedProjectId && projects.find(p => p.id === savedProjectId)) {
                            setActiveProject(savedProjectId);
                        } else {
                            setActiveProject(projects[0].id);
                        }
                    }
                },
                (error) => {
                    console.error('Projects listener error:', error);
                    showNotification('Failed to load projects', 'error');
                }
            );
        }
        
        function setupCandidatesListener(projectId) {
    if (!projectId) return;
    if (unsubscribes.candidates) unsubscribes.candidates();
    
    const candidatesRef = db.collection(`users/${userId}/projects/${projectId}/candidates`);
    unsubscribes.candidates = candidatesRef.onSnapshot(
        (snapshot) => {
            candidates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filterCandidates(); // Apply filters
            if (currentView === 'candidates') renderCandidates();
        },
        (error) => {
            console.error('Candidates listener error:', error);
        }
    );
}
        
        function setupKnowledgeListener(projectId) {
            const knowledgeRef = db.collection(`users/${userId}/projects/${projectId}/knowledge`);
            knowledgeRef.onSnapshot(
                (snapshot) => {
                    knowledgeBase[projectId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentView === 'knowledge' && activeProject?.id === projectId) {
                        renderKnowledgeBase();
                    }
                },
                (error) => {
                    console.error('Knowledge listener error:', error);
                }
            );
        }
        
        function setupPositionsListener(projectId) {
            const positionsRef = db.collection(`users/${userId}/projects/${projectId}/positions`);
            positionsRef.onSnapshot(
                (snapshot) => {
                    positions[projectId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentView === 'knowledge' && activeProject?.id === projectId) {
                        renderKnowledgeBase();
                    }
                },
                (error) => {
                    console.error('Positions listener error:', error);
                }
            );
        }
        
        function setupDemobListener() {
            if (unsubscribes.demob) unsubscribes.demob();
            
            // Listen to demob profiles collection
            const demobRef = db.collection('demob_profiles');
            unsubscribes.demob = demobRef
                .orderBy('demob_date', 'asc')
                .limit(100)
                .onSnapshot(
                    (snapshot) => {
                        demobProfiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateDemobCount();
                        if (currentView === 'demob') renderDemobView();
                    },
                    (error) => {
                        console.error('Demob listener error:', error);
                    }
                );
            
            // Listen to demob matches
            if (unsubscribes.matches) unsubscribes.matches();
            const matchesRef = db.collection('demob_matches');
            unsubscribes.matches = matchesRef
                .orderBy('match_score', 'desc')
                .limit(200)
                .onSnapshot(
                    (snapshot) => {
                        demobMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (currentView === 'demob') renderDemobView();
                    },
                    (error) => {
                        console.error('Matches listener error:', error);
                    }
                );
        }
        
        function setupDatabaseListener() {
            if (unsubscribes.database) unsubscribes.database();
            
            const databaseRef = db.collection('cv_database');
            unsubscribes.database = databaseRef
                .orderBy('metadata.processing_date', 'desc')
                .limit(500)
                .onSnapshot(
                    (snapshot) => {
                        databaseCandidates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        filteredDatabaseCandidates = [...databaseCandidates];
                        
                        // Update database count in sidebar
                        const countEl = document.getElementById('database-count');
                        if (countEl) {
                            countEl.textContent = databaseCandidates.length;
                        }
                        
                        // Calculate storage usage
                        totalStorageUsed = databaseCandidates.reduce((total, candidate) => {
                            return total + (candidate.metadata?.file_size || 0);
                        }, 0);
                        
                        if (currentView === 'database') {
                            renderDatabaseView();
                            updateStorageDisplay();
                            updateDatabaseStatistics();
                        }
                    },
                    (error) => {
                        console.error('Database listener error:', error);
                    }
                );
        }
        
        function updateDemobCount() {
            const urgentCount = demobProfiles.filter(p => {
                const days = getDaysUntilDemob(p.demob_date);
                return days !== null && days <= 90;
            }).length;
            
            const countEl = document.getElementById('demob-count');
            if (urgentCount > 0) {
                countEl.textContent = urgentCount;
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }
        }
        
        // --- PROJECT MANAGEMENT ---
        
        function setActiveProject(projectId) {
            activeProject = projects.find(p => p.id === projectId);
            if (activeProject) {
                localStorage.setItem('activeProjectId', projectId);
                document.getElementById('active-project-select').value = projectId;
                setupCandidatesListener(projectId);
                showNotification(`Active project: ${activeProject.projectName}`, 'info');
                
                // Show/hide project selector based on view
                const hideProjectSelector = ['configuration', 'analytics', 'database'].includes(currentView);
                document.getElementById('project-selector-bar').style.display = hideProjectSelector ? 'none' : 'block';
            }
        }
        
        function updateProjectSelector() {
            const select = document.getElementById('active-project-select');
            select.innerHTML = '<option value="">Select a project...</option>' +
                projects.map(p => `<option value="${p.id}">${p.projectName}</option>`).join('');
            
            if (activeProject) {
                select.value = activeProject.id;
            }
        }
        
        // --- VIEW SWITCHING ---
        
        function switchView(view) {
            currentView = view;
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === view);
            });
            
            // Show/hide project selector based on view
            const hideProjectSelector = ['configuration', 'analytics', 'database'].includes(view);
            document.getElementById('project-selector-bar').style.display = hideProjectSelector ? 'none' : 'block';
            
            // Render view
            switch (view) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'database':
                    renderDatabaseView();
                    break;
                case 'configuration':
                    renderConfiguration();
                    break;
                case 'projects':
                    renderProjects();
                    break;
                case 'candidates':
                    renderCandidates();
                    break;
                case 'demob':
                    renderDemobView();
                    break;
                case 'knowledge':
                    renderKnowledgeBase();
                    break;
                case 'analytics':
                    renderAnalytics();
                    break;
            }
        }
        
        // --- RENDER FUNCTIONS ---
        
        async function renderDashboard() {
            const mainView = document.getElementById('main-view');
            
            // Calculate statistics
            const totalCandidates = candidates.length;
            const totalProjects = projects.length;
            const totalDatabaseProfiles = databaseCandidates.length;
            const urgentDemob = demobProfiles.filter(p => {
                const days = getDaysUntilDemob(p.demob_date);
                return days !== null && days <= 30;
            }).length;
            const pendingMatches = demobMatches.filter(m => m.status === 'Pending Review').length;
            
            mainView.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Command Center Dashboard</h2>
                    <p class="text-gray-400">Welcome back, ${auth.currentUser?.displayName || 'User'}</p>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="stat-label">CV Database</p>
                                <p class="stat-value text-cyan-400">${totalDatabaseProfiles}</p>
                                <p class="text-xs text-gray-500 mt-1">Total profiles</p>
                            </div>
                            <svg class="w-12 h-12 text-cyan-500 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                            </svg>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="stat-label">Active Projects</p>
                                <p class="stat-value">${totalProjects}</p>
                            </div>
                            <svg class="w-12 h-12 text-green-500 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            </svg>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="stat-label">Project Candidates</p>
                                <p class="stat-value">${totalCandidates}</p>
                            </div>
                            <svg class="w-12 h-12 text-blue-500 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="stat-label">Urgent Demob</p>
                                <p class="stat-value text-red-400">${urgentDemob}</p>
                                <p class="text-xs text-gray-500 mt-1">Within 30 days</p>
                            </div>
                            <svg class="w-12 h-12 text-red-500 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            <button class="btn-primary w-full" onclick="document.getElementById('cv-database-input').click()">
                                Upload CVs to Database
                            </button>
                            <button class="btn-secondary w-full" onclick="window.switchView('database')">
                                View CV Database
                            </button>
                            <button class="btn-secondary w-full" onclick="window.switchView('candidates')">
                                Process Project Candidates
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">System Status</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-400">Storage Usage</span>
                                <span class="text-sm">${formatFileSize(totalStorageUsed)} / ${formatFileSize(maxStorage)}</span>
                            </div>
                            <div class="storage-meter">
                                <div class="storage-fill bg-gradient-to-r from-cyan-500 to-blue-500" style="width: ${(totalStorageUsed / maxStorage * 100).toFixed(1)}%"></div>
                            </div>
                            <div class="flex items-center gap-3 mt-4">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-sm text-gray-400">System operational</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                <span class="text-sm text-gray-400">AI processing available</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
       function renderDatabaseView() {
    const mainView = document.getElementById('main-view');
    try {
        renderDatabaseTable();
    } catch (error) {
        console.error('Error rendering database view:', error);
    }
}

        function renderDatabaseTable() {
    const mainView = document.getElementById('main-view');
    
    const startIndex = (currentDatabasePage - 1) * databasePageSize;
    const endIndex = startIndex + databasePageSize;
    const paginatedCandidates = filteredDatabaseCandidates.slice(startIndex, endIndex);
    const totalPages = Math.ceil(filteredDatabaseCandidates.length / databasePageSize);
    
    mainView.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold">CV Database</h2>
                    <p class="text-gray-400 mt-1">Centralized candidate repository</p>
                </div>
                <div class="flex gap-3">
                    <button class="btn-primary" onclick="document.getElementById('cv-database-input').click()">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Upload CVs
                    </button>
                    <button class="btn-secondary" onclick="window.exportDatabaseToCSV()">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export CSV
                    </button>
                    <button class="btn-secondary" onclick="window.openProcessingModeModal()">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Processing Mode
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Storage & Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <p class="stat-label">Total Profiles</p>
                <p class="stat-value" id="total-profiles">${databaseCandidates.length}</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Verified Contacts</p>
                <p class="stat-value text-green-400" id="verified-contacts">
                    ${databaseCandidates.filter(c => {
                        const p = c.candidate_profile?.personal_info || {};
                        return validateEmail(p.email) && validatePhone(p.phone);
                    }).length}
                </p>
            </div>
            <div class="stat-card">
                <p class="stat-label">This Month</p>
                <p class="stat-value" id="monthly-uploads">
                    ${(() => {
                        const thisMonth = new Date();
                        thisMonth.setDate(1);
                        return databaseCandidates.filter(c => {
                            const processDate = c.metadata?.processing_date?.toDate();
                            return processDate && processDate >= thisMonth;
                        }).length;
                    })()}
                </p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Avg. Processing</p>
                <p class="stat-value" id="avg-processing-time">
                    ${processingTimes.length > 0 ? 
                        (processingTimes.reduce((a, b) => a + b) / processingTimes.length / 1000).toFixed(1) + 's' : 
                        '0s'}
                </p>
            </div>
        </div>
        
        <!-- Processing Statistics -->
        ${processingStats.totalProcessed > 0 ? `
            <div class="card mb-6">
                <h3 class="text-lg font-semibold mb-4">Processing Statistics</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <p class="text-gray-400">Total Processed</p>
                        <p class="text-lg font-semibold text-green-400">${processingStats.totalProcessed}</p>
                    </div>
                    <div>
                        <p class="text-gray-400">API Calls Saved</p>
                        <p class="text-lg font-semibold text-cyan-400">${processingStats.costSavings}</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Batch Processed</p>
                        <p class="text-lg font-semibold text-purple-400">${processingStats.batchesProcessed}</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Success Rate</p>
                        <p class="text-lg font-semibold text-yellow-400">
                            ${Math.round((processingStats.totalProcessed / 
                                (processingStats.totalProcessed + processingStats.totalFailed)) * 100)}%
                        </p>
                    </div>
                </div>
            </div>
        ` : ''}
        
        <!-- Storage Meter -->
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold">Storage Usage</h3>
                <span class="text-sm text-gray-400">
                    <span id="storage-percentage">${((totalStorageUsed / maxStorage) * 100).toFixed(1)}%</span> used
                </span>
            </div>
            <div class="storage-meter">
                <div id="storage-fill" class="storage-fill bg-gradient-to-r from-cyan-500 to-blue-500" 
                    style="width: ${((totalStorageUsed / maxStorage) * 100).toFixed(1)}%"></div>
            </div>
            <div class="flex justify-between mt-2 text-sm text-gray-400">
                <span><span id="storage-used">${formatFileSize(totalStorageUsed)}</span> used</span>
                <span><span id="storage-total">${formatFileSize(maxStorage)}</span> total</span>
            </div>
        </div>
        
        <!-- Drop Zone -->
        <div id="database-drop-zone" class="drop-zone mb-6">
            <svg class="w-12 h-12 mx-auto text-gray-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="text-gray-400">Drag and drop CV files here, or click to browse</p>
            <p class="text-xs text-gray-500 mt-2">PDF and DOCX files only. Max 5MB per file.</p>
        </div>
        
        <!-- Enhanced Search and Filters -->
        <div class="card mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="md:col-span-2">
                    <div class="relative">
                        <input type="text" id="database-search" 
                            placeholder="Quick search by name, email, skills, company..." 
                            class="input w-full pl-10" 
                            onkeyup="window.searchDatabase(this.value)">
                        <svg class="w-5 h-5 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                <div>
                    <select id="database-filter" class="select w-full" 
                        onchange="window.filterDatabaseByLocation(this.value)">
                        <option value="">All Locations</option>
                        <option value="usa">USA</option>
                        <option value="canada">Canada</option>
                        <option value="uk">UK</option>
                        <option value="uae">UAE</option>
                        <option value="australia">Australia</option>
                        <option value="india">India</option>
                        <option value="singapore">Singapore</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <button class="btn-primary w-full flex items-center justify-center" onclick="window.openAdvancedSearchModal()">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        Advanced Search
                    </button>
                </div>
            </div>
            
            <!-- Active filters display area -->
            <div id="search-info"></div>
            
            <!-- Quick Filters Section -->
            <div class="border-t border-gray-700 pt-4">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm font-medium text-gray-300">Quick Skill Filters</p>
                    <div class="flex gap-2">
                        <button class="text-cyan-400 hover:text-cyan-300 text-xs" onclick="window.clearAllFilters()">
                            Clear All Filters
                        </button>
                        <span class="text-gray-600">|</span>
                        <button class="text-blue-400 hover:text-blue-300 text-xs" onclick="window.exportFilteredResults()">
                            Export Filtered (${filteredDatabaseCandidates.length})
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <!-- Project Management Skills -->
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-gray-500">PM:</span>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['project management'])">
                            Project Management
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['PMP'])">
                            PMP
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['agile', 'scrum'])">
                            Agile/Scrum
                        </button>
                    </div>
                    
                    <span class="text-gray-600">|</span>
                    
                    <!-- Planning & Controls -->
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-gray-500">Planning:</span>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['planning'])">
                            Planning
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['primavera', 'P6'])">
                            Primavera P6
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['cost control'])">
                            Cost Control
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['scheduling'])">
                            Scheduling
                        </button>
                    </div>
                    
                    <span class="text-gray-600">|</span>
                    
                    <!-- Industry -->
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-gray-500">Industry:</span>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['construction'])">
                            Construction
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['engineering'])">
                            Engineering
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['infrastructure'])">
                            Infrastructure
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['oil', 'gas'])">
                            Oil & Gas
                        </button>
                    </div>
                    
                    <span class="text-gray-600">|</span>
                    
                    <!-- Technical Skills -->
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-gray-500">Tech:</span>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['BIM'])">
                            BIM
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['AutoCAD'])">
                            AutoCAD
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['SAP'])">
                            SAP
                        </button>
                        <button class="skill-tag hover:bg-cyan-900 hover:border-cyan-400" 
                            onclick="window.filterDatabaseBySkills(['ERP'])">
                            ERP
                        </button>
                    </div>
                </div>
                
                <!-- Experience Level Quick Filters -->
                <div class="mt-3 pt-3 border-t border-gray-700">
                    <p class="text-xs text-gray-500 mb-2">Experience Level:</p>
                    <div class="flex gap-2">
                        <button class="text-xs px-3 py-1 bg-gray-800 rounded-full hover:bg-gray-700 border border-gray-700 hover:border-cyan-400" 
                            onclick="window.filterByExperienceLevel('entry')">
                            Entry (0-3 years)
                        </button>
                        <button class="text-xs px-3 py-1 bg-gray-800 rounded-full hover:bg-gray-700 border border-gray-700 hover:border-cyan-400" 
                            onclick="window.filterByExperienceLevel('mid')">
                            Mid (4-8 years)
                        </button>
                        <button class="text-xs px-3 py-1 bg-gray-800 rounded-full hover:bg-gray-700 border border-gray-700 hover:border-cyan-400" 
                            onclick="window.filterByExperienceLevel('senior')">
                            Senior (9-15 years)
                        </button>
                        <button class="text-xs px-3 py-1 bg-gray-800 rounded-full hover:bg-gray-700 border border-gray-700 hover:border-cyan-400" 
                            onclick="window.filterByExperienceLevel('expert')">
                            Expert (15+ years)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Candidates Table -->
        ${filteredDatabaseCandidates.length > 0 ? `
            <div class="card overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Position</th>
                            <th>Experience</th>
                            <th>Location</th>
                            <th>Skills</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedCandidates.map(candidate => renderDatabaseRow(candidate)).join('')}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            ${filteredDatabaseCandidates.length > databasePageSize ? `
                <div class="flex justify-between items-center mt-6">
                    <p class="text-sm text-gray-400">
                        Showing ${startIndex + 1} - ${Math.min(endIndex, filteredDatabaseCandidates.length)} 
                        of ${filteredDatabaseCandidates.length} candidates
                    </p>
                    <div class="flex gap-2">
                        <button class="btn-secondary ${currentDatabasePage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
                            onclick="window.changeDatabasePage(-1)" 
                            ${currentDatabasePage === 1 ? 'disabled' : ''}>
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            Previous
                        </button>
                        <span class="px-4 py-2 text-sm bg-gray-800 rounded-lg">
                            Page ${currentDatabasePage} of ${totalPages}
                        </span>
                        <button class="btn-secondary ${currentDatabasePage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" 
                            onclick="window.changeDatabasePage(1)" 
                            ${currentDatabasePage === totalPages ? 'disabled' : ''}>
                            Next
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            ` : ''}
        ` : `
            <div class="text-center py-20">
                <svg class="w-16 h-16 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p class="text-gray-400 mb-4">
                    ${databaseCandidates.length === 0 ? 'No candidates in database yet' : 'No candidates match your filters'}
                </p>
                ${databaseCandidates.length === 0 ? `
                    <button class="btn-primary" onclick="document.getElementById('cv-database-input').click()">
                        Upload First CV
                    </button>
                ` : `
                    <button class="btn-secondary" onclick="window.clearAllFilters()">
                        Clear Filters
                    </button>
                `}
            </div>
        `}
    `;
    
    // Setup drag and drop
    setupDatabaseDragAndDrop();
    
    // Update statistics
    updateDatabaseStatistics();
}
        
        function renderDatabaseRow(candidate) {
            const profile = candidate.candidate_profile || {};
            const personal = profile.personal_info || {};
            const professional = profile.professional_summary || {};
            const skills = profile.skills?.technical_skills || [];
            
            const emailValid = validateEmail(personal.email);
            const phoneValid = validatePhone(personal.phone);
            
            // Check if this is a duplicate (has been updated)
            const isDuplicate = candidate.metadata?.update_count > 0;
            
            return `
                <tr class="data-row">
                    <td>
                        <div class="font-medium">${personal.full_name || 'Unknown'}</div>
                        <div class="text-xs text-gray-500">
                            ${candidate.metadata?.source_file || ''}
                            ${isDuplicate ? '<span class="duplicate-badge ml-2">Updated</span>' : ''}
                        </div>
                    </td>
                    <td>
                        <div class="text-sm">
                            ${personal.email ? `
                                <span class="${emailValid ? 'contact-verified' : 'contact-unverified'}">
                                    ${personal.email}
                                </span>
                            ` : '-'}
                        </div>
                        <div class="text-sm">
                            ${personal.phone ? `
                                <span class="${phoneValid ? 'contact-verified' : 'contact-unverified'}">
                                    ${personal.phone}
                                </span>
                            ` : '-'}
                        </div>
                    </td>
                    <td>
                        <div class="text-sm">${professional.current_position || '-'}</div>
                        <div class="text-xs text-gray-500">${professional.industry || ''}</div>
                    </td>
                    <td class="text-sm">
                        ${professional.total_experience_years ? `${professional.total_experience_years} years` : '-'}
                    </td>
                    <td class="text-sm">
                        ${personal.location || '-'}
                    </td>
                    <td>
                        <div class="flex flex-wrap gap-1">
                            ${skills.slice(0, 3).map(skill => `
                                <span class="skill-tag">${skill}</span>
                            `).join('')}
                            ${skills.length > 3 ? `
                                <span class="text-xs text-gray-500">+${skills.length - 3}</span>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="flex gap-2">
                            <button class="text-cyan-400 hover:text-cyan-300" onclick="window.viewDatabaseCandidate('${candidate.id}')">
                                View
                            </button>
                            <button class="text-blue-400 hover:text-blue-300" onclick="window.addToProject('${candidate.id}')">
                                Add to Project
                            </button>
                            ${userPermissions.edit_candidates ? `
                                <button class="text-red-400 hover:text-red-300" onclick="window.deleteDatabaseCandidate('${candidate.id}')">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // Database Pagination
        window.changeDatabasePage = (direction) => {
            const totalPages = Math.ceil(filteredDatabaseCandidates.length / databasePageSize);
            const newPage = currentDatabasePage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentDatabasePage = newPage;
                renderDatabaseTable();
            }
        };
        
        // Database View Functions
        window.viewDatabaseCandidate = (candidateId) => {
            const candidate = databaseCandidates.find(c => c.id === candidateId);
            if (!candidate) return;
            
            const profile = candidate.candidate_profile || {};
            const personal = profile.personal_info || {};
            const professional = profile.professional_summary || {};
            
            openModal(`
                <div class="p-6 max-w-4xl">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-2xl font-bold">${personal.full_name || 'Unknown'}</h3>
                            <p class="text-gray-400">${professional.current_position || 'Position not specified'}</p>
                        </div>
                        <button class="close-button" onclick="window.closeModal()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Personal Information -->
                        <div class="card">
                            <h4 class="font-semibold mb-3">Contact Information</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Email:</span>
                                    <span class="${validateEmail(personal.email) ? 'contact-verified' : 'contact-unverified'}">
                                        ${personal.email || 'Not provided'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Phone:</span>
                                    <span class="${validatePhone(personal.phone) ? 'contact-verified' : 'contact-unverified'}">
                                        ${personal.phone || 'Not provided'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Location:</span>
                                    <span>${personal.location || 'Not specified'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Nationality:</span>
                                    <span>${personal.nationality || 'Not specified'}</span>
                                </div>
                                ${personal.linkedin_url ? `
                                    <div class="mt-3">
                                        <a href="${personal.linkedin_url}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">
                                            View LinkedIn Profile 
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Professional Summary -->
                        <div class="card">
                            <h4 class="font-semibold mb-3">Professional Summary</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Experience:</span>
                                    <span>${professional.total_experience_years ? `${professional.total_experience_years} years` : 'Not specified'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Industry:</span>
                                    <span>${professional.industry || 'Not specified'}</span>
                                </div>
                                <div class="mt-3">
                                    <p class="text-gray-400 mb-1">Summary:</p>
                                    <p class="text-sm">${professional.summary || 'No summary available'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Skills -->
                        <div class="card">
                            <h4 class="font-semibold mb-3">Skills & Certifications</h4>
                            <div class="space-y-3">
                                ${profile.skills?.technical_skills?.length > 0 ? `
                                    <div>
                                        <p class="text-sm text-gray-400 mb-2">Technical Skills:</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${profile.skills.technical_skills.map(skill => `
                                                <span class="skill-tag">${skill}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${profile.skills?.certifications?.length > 0 ? `
                                    <div>
                                        <p class="text-sm text-gray-400 mb-2">Certifications:</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${profile.skills.certifications.map(cert => `
                                                <span class="badge badge-primary">${cert}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${profile.skills?.languages?.length > 0 ? `
                                    <div>
                                        <p class="text-sm text-gray-400 mb-2">Languages:</p>
                                        <p class="text-sm">${profile.skills.languages.join(', ')}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Experience -->
                        <div class="card">
                            <h4 class="font-semibold mb-3">Experience</h4>
                            <div class="space-y-3">
                                ${(profile.experience || []).slice(0, 3).map(exp => `
                                    <div class="border-l-2 border-gray-700 pl-3">
                                        <p class="font-medium text-sm">${exp.position}</p>
                                        <p class="text-sm text-gray-400">${exp.company} | ${exp.duration}</p>
                                        ${exp.location ? `<p class="text-xs text-gray-500">${exp.location}</p>` : ''}
                                        ${exp.key_achievements?.length > 0 ? `
                                            <ul class="list-disc list-inside text-xs text-gray-400 mt-1">
                                                ${exp.key_achievements.map(ach => `<li>${ach}</li>`).join('')}
                                            </ul>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Education -->
                        ${profile.education?.length > 0 ? `
                            <div class="card">
                                <h4 class="font-semibold mb-3">Education</h4>
                                <div class="space-y-3">
                                    ${profile.education.map(edu => `
                                        <div class="text-sm">
                                            <p class="font-medium">${edu.degree}</p>
                                            <p class="text-gray-400">${edu.institution}</p>
                                            <p class="text-xs text-gray-500">${edu.field} | ${edu.year || 'Year not specified'}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Availability -->
                        <div class="card">
                            <h4 class="font-semibold mb-3">Availability</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Notice Period:</span>
                                    <span>${profile.availability?.notice_period || 'Not specified'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Preferred Location:</span>
                                    <span>${profile.availability?.preferred_location || 'Not specified'}</span>
                                </div>
                                ${profile.availability?.salary_expectation ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Salary Expectation:</span>
                                        <span>${profile.availability.salary_expectation}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metadata -->
                    <div class="mt-6 p-4 bg-gray-800 rounded-lg">
                        <h4 class="font-semibold mb-2 text-sm">Processing Information</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs text-gray-400">
                            <div>
                                <p>Source File:</p>
                                <p class="text-gray-300">${candidate.metadata?.source_file || 'Unknown'}</p>
                            </div>
                            <div>
                                <p>File Size:</p>
                                <p class="text-gray-300">${formatFileSize(candidate.metadata?.file_size || 0)}</p>
                            </div>
                            <div>
                                <p>Processed Date:</p>
                                <p class="text-gray-300">${formatDate(candidate.metadata?.processing_date?.toDate())}</p>
                            </div>
                            <div>
                                <p>Confidence Scores:</p>
                                <p class="text-gray-300">
                                    E: ${profile.contact_verification?.email_confidence || 'N/A'} | 
                                    P: ${profile.contact_verification?.phone_confidence || 'N/A'}
                                </p>
                            </div>
                        </div>
                        ${candidate.metadata?.update_count > 0 ? `
                            <div class="mt-2 text-xs text-gray-400">
                                <p>Update Count: ${candidate.metadata.update_count}</p>
                                <p>Last Updated: ${formatDate(candidate.metadata?.last_updated?.toDate())}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex gap-3 justify-end mt-6">
                        <button class="btn-secondary" onclick="window.closeModal()">Close</button>
                        <button class="btn-primary" onclick="window.addToProject('${candidate.id}')">
                            Add to Project
                        </button>
                        ${userPermissions.edit_candidates ? `
                            <button class="btn-danger" onclick="window.deleteDatabaseCandidate('${candidate.id}')">
                                Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `);
        };
        
        window.addToProject = async (candidateId) => {
            if (!activeProject) {
                showNotification('Please select a project first', 'error');
                return;
            }
            
            const candidate = databaseCandidates.find(c => c.id === candidateId);
            if (!candidate) return;
            
            try {
                // Create a candidate record in the active project
                const profile = candidate.candidate_profile || {};
                const candidateData = {
                    fileName: candidate.metadata?.source_file || 'Database Import',
                    rawContent: JSON.stringify(profile).substring(0, 1000),
                    screening_summary: {
                        candidate_name: profile.personal_info?.full_name || 'Unknown',
                        overall_fit: 'Not Analyzed',
                        recommended_roles: [],
                        key_strengths: profile.skills?.technical_skills?.slice(0, 5) || [],
                        potential_gaps: [],
                        notice_period: profile.availability?.notice_period || 'Not specified'
                    },
                    must_have_compliance: {},
                    database_import: true,
                    original_database_id: candidateId,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection(`users/${userId}/projects/${activeProject.id}/candidates`).add(candidateData);
                
                showNotification(`Added ${profile.personal_info?.full_name || 'candidate'} to ${activeProject.projectName}`, 'success');
                closeModal();
                
            } catch (error) {
                showNotification('Failed to add candidate to project: ' + error.message, 'error');
            }
        };
        
        function renderConfiguration() {
            const mainView = document.getElementById('main-view');
            
            mainView.innerHTML = `
                <div class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Configuration</h2>
                    <p class="text-gray-400">Manage system components and settings</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Project Management -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Project Management</h3>
                        <div class="space-y-4">
                            <button class="btn-primary w-full" onclick="window.openAddProjectModal()">
                                + Add New Project
                            </button>
                            
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${projects.map(project => `
                                    <div class="bg-gray-800 rounded-lg p-3 flex justify-between items-center">
                                        <span>${project.projectName}</span>
                                        <div class="flex gap-2">
                                            <button class="text-cyan-400 hover:text-cyan-300 text-sm" onclick="window.openProjectDetails('${project.id}')">
                                                Edit
                                            </button>
                                            ${userPermissions.edit_candidates ? `
                                                <button class="text-red-400 hover:text-red-300 text-sm" onclick="window.deleteProject('${project.id}')">
                                                    Delete
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Position Management -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Position Management</h3>
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <select id="config-project-select" class="select flex-1">
                                    <option value="">Select project...</option>
                                    ${projects.map(p => `<option value="${p.id}">${p.projectName}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="flex gap-2">
                                <button class="btn-primary flex-1" onclick="window.openAddPositionModal()" id="add-position-btn" disabled>
                                    + Add Position
                                </button>
                                <button class="btn-secondary flex-1" onclick="document.getElementById('positions-upload-input').click()" id="bulk-upload-btn" disabled>
                                    Bulk Upload
                                </button>
                            </div>
                            
                            <div id="position-list" class="space-y-2 max-h-48 overflow-y-auto">
                                <p class="text-gray-500 text-sm text-center">Select a project to view positions</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Settings -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">System Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Gemini API Key</label>
                                <input type="password" id="api-key-input" class="input w-full" 
                                    value="${localStorage.getItem('gemini_api_key') || ''}" placeholder="Enter your Gemini API key">
                            </div>
                            
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Recruiter Name</label>
                                <input type="text" id="recruiter-name-input" class="input w-full" 
                                    value="${localStorage.getItem('recruiter_name') || ''}" placeholder="Your name for email signatures">
                            </div>
                            
                            <button class="btn-primary w-full" onclick="window.saveConfigSettings()">
                                Save Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Database Settings -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Database Management</h3>
                        <div class="space-y-4">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400">Storage Usage</p>
                                <p class="text-lg font-medium">${formatFileSize(totalStorageUsed)} / ${formatFileSize(maxStorage)}</p>
                                <div class="storage-meter mt-2">
                                    <div class="storage-fill bg-gradient-to-r from-cyan-500 to-blue-500" 
                                        style="width: ${(totalStorageUsed / maxStorage * 100).toFixed(1)}%"></div>
                                </div>
                            </div>
                            
                            <button class="btn-secondary w-full" onclick="window.cleanupOldRecords()">
                                Cleanup Old Records (30+ days)
                            </button>
                            
                            <button class="btn-danger w-full" onclick="window.clearDatabase()">
                                Clear Entire Database
                            </button>
                        </div>
                    </div>
                    
                    <!-- User Management -->
                    ${userPermissions.manage_users ? `
                        <div class="card">
                            <h3 class="text-xl font-semibold mb-4">User Management</h3>
                            <div class="space-y-4">
                                <button class="btn-primary w-full" onclick="window.openUserManagement()">
                                    Manage Users & Permissions
                                </button>
                                
                                <div class="bg-gray-800 rounded-lg p-4">
                                    <p class="text-sm text-gray-400">Current User Role</p>
                                    <p class="text-lg font-medium capitalize">${userRole}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
			
			
			
			
			
			
			
			
			
			
			
			
			
			
            
            // Add event listener for project selection in configuration
            document.getElementById('config-project-select').addEventListener('change', (e) => {
                const projectId = e.target.value;
                const addBtn = document.getElementById('add-position-btn');
                const bulkBtn = document.getElementById('bulk-upload-btn');
                const positionList = document.getElementById('position-list');
                
                if (projectId) {
                    addBtn.disabled = false;
                    bulkBtn.disabled = false;
                    
                    const projectPositions = positions[projectId] || [];
                    if (projectPositions.length === 0) {
                        positionList.innerHTML = '<p class="text-gray-500 text-sm text-center">No positions added yet</p>';
                    } else {
                        positionList.innerHTML = projectPositions.map(pos => `
                            <div class="bg-gray-800 rounded-lg p-3">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium">${pos.title}</p>
                                        <p class="text-xs text-gray-400 mt-1">${pos.description.substring(0, 100)}...</p>
                                    </div>
                                    ${userPermissions.edit_candidates ? `
                                        <button class="text-red-400 hover:text-red-300 ml-2" onclick="window.deletePosition('${pos.id}', '${projectId}')">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    addBtn.disabled = true;
                    bulkBtn.disabled = true;
                    positionList.innerHTML = '<p class="text-gray-500 text-sm text-center">Select a project to view positions</p>';
                }
            });
        }
		window.updateCandidateInterest = async (candidateId, status) => {
    try {
        await db.collection(`users/${userId}/projects/${activeProject.id}/candidates`)
            .doc(candidateId)
            .update({
                interestStatus: status,
                interestStatusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        // Update local data
        const candidate = candidates.find(c => c.id === candidateId);
        if (candidate) {
            candidate.interestStatus = status;
        }
        
        // Show notification based on status
        const statusText = status === 'interested' ? 'Interested' : 
                          status === 'not_interested' ? 'Not Interested' : 'Yet to Decide';
        showNotification(`Marked candidate as ${statusText}`, 'success');
        
    } catch (error) {
        showNotification('Failed to update candidate interest: ' + error.message, 'error');
    }
};
        window.updateEmailStatus = async (candidateId, isChecked) => {
    try {
        const updateData = {
            emailSent: isChecked
        };
        
        if (isChecked) {
            // When checking the box, save email details
            const candidate = candidates.find(c => c.id === candidateId);
            updateData.emailSentDate = firebase.firestore.FieldValue.serverTimestamp();
            updateData.emailDetails = {
                position: candidate?.screening_summary?.recommended_roles?.[0] || 'Unknown',
                project: activeProject.projectName,
                projectId: activeProject.id,
                sentBy: auth.currentUser?.email || 'Unknown'
            };
        } else {
            // When unchecking, optionally clear the data
            updateData.emailSentDate = null;
            updateData.emailDetails = null;
        }
        
        await db.collection(`users/${userId}/projects/${activeProject.id}/candidates`)
            .doc(candidateId)
            .update(updateData);
        
        // Update local data
        const candidate = candidates.find(c => c.id === candidateId);
        if (candidate) {
            candidate.emailSent = isChecked;
            if (isChecked) {
                candidate.emailSentDate = { toDate: () => new Date() };
                candidate.emailDetails = updateData.emailDetails;
            }
        }
        
        showNotification(isChecked ? 'Marked as email sent' : 'Email status updated', 'success');
        
    } catch (error) {
        showNotification('Failed to update email status: ' + error.message, 'error');
    }
};
        // Database management functions
        window.cleanupOldRecords = async () => {
            if (!confirm('This will permanently delete all CV records older than 30 days. Continue?')) return;
            
            showLoading(true);
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                let deletedCount = 0;
                const batch = db.batch();
                
                const oldRecords = await db.collection('cv_database')
                    .where('metadata.processing_date', '<', thirtyDaysAgo)
                    .get();
                
                oldRecords.forEach(doc => {
                    batch.delete(doc.ref);
                    deletedCount++;
                });
                
                await batch.commit();
                
                showNotification(`Deleted ${deletedCount} old records`, 'success');
                
                // Reload database
                await loadDatabaseCandidates();
                
            } catch (error) {
                showNotification('Cleanup failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        window.clearDatabase = async () => {
            if (!confirm('WARNING: This will permanently delete ALL CV records from the database. This action cannot be undone. Continue?')) return;
            if (!confirm('Are you absolutely sure? All CV data will be lost forever.')) return;
            
            showLoading(true);
            try {
                const allRecords = await db.collection('cv_database').get();
                let batch = db.batch();
                let count = 0;
                
                allRecords.forEach(doc => {
                    batch.delete(doc.ref);
                    count++;
                    if (count % 500 === 0) {
                        // Commit batch every 500 records
                        batch.commit();
                        batch = db.batch();
                    }
                });
                
                await batch.commit();
                
                showNotification('Database cleared successfully', 'success');
                
                // Reset storage
                totalStorageUsed = 0;
                databaseCandidates = [];
                filteredDatabaseCandidates = [];
                
                if (currentView === 'database') {
                    renderDatabaseView();
                }
                
            } catch (error) {
                showNotification('Failed to clear database: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        // Setup drag and drop for database
        function setupDatabaseDragAndDrop() {
            const dropZone = document.getElementById('database-drop-zone');
            if (!dropZone) return;
            
            dropZone.addEventListener('click', () => {
                document.getElementById('cv-database-input').click();
            });
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('active');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    processDatabaseFiles(files);
                }
            });
        }
        
        // Existing render functions continue...
        function renderProjects() {
            const mainView = document.getElementById('main-view');
            
            mainView.innerHTML = `
                <div class="mb-8">
                    <div class="flex justify-between items-center">
                        <h2 class="text-3xl font-bold">Projects</h2>
                        <button class="btn-primary" onclick="window.openAddProjectModal()">
                            + Add Project
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${projects.map(project => `
                        <div class="card hover:border-cyan-700 cursor-pointer" onclick="window.openProjectDetails('${project.id}')">
                            <h3 class="text-xl font-semibold mb-2">${project.projectName}</h3>
                            <div class="space-y-2 text-sm text-gray-400">
                                <p>Positions: ${(positions[project.id] || []).length}</p>
                                <p>Knowledge Docs: ${(knowledgeBase[project.id] || []).length}</p>
                                <p>Created: ${formatDate(project.createdAt?.toDate())}</p>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button class="btn-secondary text-sm" onclick="event.stopPropagation(); window.setActiveProject('${project.id}')">
                                    Set Active
                                </button>
                                ${userPermissions.edit_candidates ? `
                                    <button class="btn-danger text-sm" onclick="event.stopPropagation(); window.deleteProject('${project.id}')">
                                        Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderCandidates() {
    const mainView = document.getElementById('main-view');
    
    if (!activeProject) {
        mainView.innerHTML = `
            <div class="text-center py-20">
                <p class="text-gray-400 mb-4">Please select a project first</p>
                <button class="btn-primary" onclick="window.switchView('projects')">
                    Go to Projects
                </button>
            </div>
        `;
        return;
    }
	// Filter candidates based on current filter settings
function filterCandidates() {
    filteredCandidates = candidates.filter(candidate => {
        // Interest status filter
        if (candidateFilters.interestStatus !== 'all') {
            const status = candidate.interestStatus || 'yet_to_decide';
            
            if (candidateFilters.interestStatus === 'exclude_not_interested' && status === 'not_interested') {
                return false;
            } else if (candidateFilters.interestStatus !== 'exclude_not_interested' && 
                       candidateFilters.interestStatus !== status) {
                return false;
            }
        }
        
        // Email sent filter
        if (candidateFilters.emailSent !== 'all') {
            const emailSent = candidate.emailSent || false;
            if (candidateFilters.emailSent === 'sent' && !emailSent) return false;
            if (candidateFilters.emailSent === 'not_Ill provide the complete code from where it was cut off, including all the email generation implementation and continuing to the end of the file.

```javascript
// Continue from where it was cut off...
// Add these missing functions
window.filterByExperienceLevel = filterByExperienceLevel;
window.filterByCertification = filterByCertification;
window.applyAdvancedFilters = applyAdvancedFilters;
window.updateCandidateInterest = updateCandidateInterest;
window.updateEmailStatus = updateEmailStatus;
window.saveAllSettings = saveAllSettings;
window.calculateEnhancedDemobMatch = calculateEnhancedDemobMatch;
window.calculateRetentionAnalytics = calculateRetentionAnalytics;

// =============== EMAIL GENERATION FUNCTIONS ===============

// Enhanced AI-powered email generation
window.generateEmail = async (candidateId, emailType = 'initial') => {
    const candidate = candidates.find(c => c.id === candidateId);
    if (!candidate) return;
    
    const apiKey = localStorage.getItem('gemini_api_key');
    
    // If no API key, fall back to template
    if (!apiKey) {
        generateTemplateEmail(candidate);
        return;
    }
    
    // Check if email was recently generated (avoid duplicates)
    if (candidate.lastGeneratedEmail && emailType === 'initial') {
        const choice = confirm('An email was already generated for this candidate. Generate a new one?');
        if (!choice) {
            navigator.clipboard.writeText(
                `Subject: ${candidate.lastGeneratedEmail.subject}\n\n${candidate.lastGeneratedEmail.body}`
            );
            showNotification('Previous email copied to clipboard', 'info');
            return;
        }
    }
    
    showLoading(true);
    
    try {
        const prompt = await buildEmailPrompt(candidate, emailType);
        const responseText = await callGemini2API(prompt, apiKey, {
            temperature: 0.6,
            maxOutputTokens: 2048
        });
        
        const emailData = JSON.parse(responseText);
        
        // Copy to clipboard
        const fullEmail = `Subject: ${emailData.email.subject}\n\n${emailData.email.body}`;
        navigator.clipboard.writeText(fullEmail);
        
        // Save email data to Firestore
        await db.collection(`users/${userId}/projects/${activeProject.id}/candidates`)
            .doc(candidateId)
            .update({
                lastGeneratedEmail: emailData.email,
                emailGeneratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                emailType: emailType,
                emailPersonalizationPoints: emailData.email.key_personalization_points || []
            });
        
        // Update local candidate object
        candidate.lastGeneratedEmail = emailData.email;
        
        showNotification('Personalized email generated and copied to clipboard', 'success');
        
        // Show email preview modal
        showEmailPreview(emailData.email, candidate);
        
        // Automatically mark email as sent
        window.updateEmailStatus(candidateId, true);
        
    } catch (error) {
        console.error('AI email generation failed:', error);
        showNotification('AI generation failed, using template instead', 'warning');
        generateTemplateEmail(candidate);
    } finally {
        showLoading(false);
    }
};

// Build email prompt based on candidate and email type
async function buildEmailPrompt(candidate, emailType) {
    const summary = candidate.screening_summary || {};
    const compliance = candidate.must_have_compliance || {};
    const recruiterName = localStorage.getItem('recruiter_name') || 'Talent Acquisition Team';
    
    // Get position details
    const projectPositions = positions[activeProject.id] || [];
    const recommendedPosition = projectPositions.find(p => 
        p.title === summary.recommended_roles?.[0]
    ) || projectPositions[0] || {};
    
    // Get project context
    const projectKnowledge = knowledgeBase[activeProject.id] || [];
    const knowledgeContext = buildEnhancedKnowledgeContext(activeProject, projectKnowledge, projectPositions);
    
    if (emailType === 'initial') {
        return `
You are RecruitPro, an AI assistant specialized in creating personalized recruitment outreach emails.

Generate a professional, engaging email to a potential candidate based on the following information:

### CANDIDATE PROFILE
Name: ${summary.candidate_name || 'Candidate'}
Current Role: ${summary.current_role || 'Professional'}
Experience: ${summary.total_experience || 'Experienced'}
Location: ${summary.location || 'Not specified'}
Key Skills: ${summary.key_skills?.join(', ') || 'Various technical skills'}
Key Strengths: ${summary.key_strengths?.join(', ') || 'Strong technical background'}
Overall Fit: ${summary.overall_fit || 'Potential Match'}
Education: ${summary.education || 'Not specified'}
Certifications: ${summary.certifications?.join(', ') || 'Not specified'}

### COMPLIANCE STATUS
Years Experience: ${compliance.years_experience ? ' Meets' : ' Gap'}
Technical Skills: ${compliance.technical_skills ? ' Meets' : ' Gap'}
Certifications: ${compliance.certifications ? ' Meets' : ' Gap'}
Location Match: ${compliance.location_match ? ' Meets' : ' Gap'}

### TARGET POSITION
Title: ${recommendedPosition.title || summary.recommended_roles?.[0] || 'Open Position'}
Description: ${recommendedPosition.description || 'Exciting opportunity in our organization'}
Location: ${recommendedPosition.location || activeProject.location || 'Canada'}
Required Skills: ${recommendedPosition.required_skills?.join(', ') || 'Technical expertise required'}
Start Date: ${recommendedPosition.start_date || 'ASAP'}

### PROJECT CONTEXT
${knowledgeContext.projectInfo.substring(0, 500)}

### RECRUITER INFORMATION
Name: ${recruiterName}
Company: ${activeProject.company || 'Egis'}
Role: Talent Acquisition Manager

### EMAIL REQUIREMENTS
1. Subject line should be compelling and mention the specific role and location
2. Personalize the greeting using the candidate's first name
3. Reference 2-3 specific achievements, skills, or experiences from their profile
4. Explain why they're specifically a good fit for THIS role
5. Mention the project/client context appropriately
6. Include a clear call-to-action
7. Professional but warm and engaging tone
8. Length: 150-200 words
9. ${summary.overall_fit === 'Strong Match' ? 'Express strong interest and urgency' : 'Be exploratory and inviting'}

### OUTPUT FORMAT
{
    "email": {
        "subject": "Compelling subject line mentioning role and location",
        "body": "Full email body text with proper formatting and paragraphs",
        "key_personalization_points": [
            "Specific achievement or skill mentioned",
            "Another specific point from CV",
            "Third personalization point"
        ],
        "tone_analysis": "Brief description of tone used",
        "follow_up_suggestion": "When and how to follow up if no response"
    }
}

### IMPORTANT INSTRUCTIONS
- Be specific, not generic. Reference actual details from the candidate profile
- Don't oversell or make unrealistic promises
- Keep it professional but conversational and warm
- If Strong Match: Express enthusiasm and urgency to connect
- If Potential Match: Focus on exploring possibilities and mutual fit
- Include company name naturally in context
- Don't mention salary unless specified in candidate's expectations
- Make the email feel personal, not like a mass template
`;
    } else if (emailType === 'followup') {
        return `
Generate a follow-up email for a candidate who hasn't responded to our initial outreach.

### PREVIOUS CONTEXT
Candidate: ${summary.candidate_name}
Role: ${summary.recommended_roles?.[0]}
Days Since Last Email: ${candidate.daysSinceLastEmail || 7}
Previous Email Sent: ${candidate.emailSentDate ? formatDate(candidate.emailSentDate.toDate()) : 'Recently'}

### REQUIREMENTS
1. Reference the previous email without being pushy
2. Add new information about the role or project
3. Mention alternative opportunities if available
4. Create gentle urgency
5. Keep it shorter than the initial email (100-150 words)
6. Friendly and understanding tone

### OUTPUT FORMAT
{
    "email": {
        "subject": "Follow-up subject line",
        "body": "Follow-up email body",
        "key_personalization_points": ["Point 1", "Point 2"],
        "tone_analysis": "Tone description",
        "follow_up_suggestion": "Next steps if still no response"
    }
}
`;
    } else if (emailType === 'linkedin') {
        return `
Generate a LinkedIn connection request message for reaching out to a candidate.

### CANDIDATE
Name: ${summary.candidate_name}
Current Role: ${summary.current_role}
Target Role: ${summary.recommended_roles?.[0]}

### REQUIREMENTS
1. Maximum 300 characters (strict limit)
2. Mention one specific detail from their profile
3. Clear about the opportunity
4. Professional but friendly
5. Include company name (${activeProject.company || 'Egis'})

### OUTPUT FORMAT
{
    "email": {
        "subject": "LinkedIn Connection Request",
        "body": "Message text (max 300 characters)",
        "key_personalization_points": ["Specific detail referenced"],
        "tone_analysis": "Brief and professional",
        "follow_up_suggestion": "Follow up via LinkedIn message after connection"
    }
}
`;
    }
}

// Fallback template email generation
function generateTemplateEmail(candidate) {
    const summary = candidate.screening_summary || {};
    const recruiterName = localStorage.getItem('recruiter_name') || 'Talent Acquisition Team';
    
    const emailText = `Subject: Exciting ${summary.recommended_roles?.[0] || 'MEP Engineer'} opportunity with ${activeProject.company || 'Egis'} in ${activeProject.location || 'Canada'}

Hi ${summary.candidate_name?.split(' ')[0] || 'there'},

I'm ${recruiterName}, a Talent Acquisition Manager at ${activeProject.company || 'Egis'}. I am reaching out regarding an exciting ${summary.recommended_roles?.[0] || 'MEP Engineer'} opportunity based in ${activeProject.location || 'Canada'}, part of a major ${activeProject.projectName || 'infrastructure'} project recently awarded to us.

Your profile stood out to me, especially your experience in ${summary.key_strengths?.[0] || 'relevant areas'}. I believe your background aligns strongly with what we're looking for.

Please find the job description attached. If this role resonates with your career goals, I'd appreciate it if you could share your updated CV and contact details. I would be glad to connect and explore this opportunity further with you.

Best regards,
${recruiterName}
Talent Acquisition Manager
${activeProject.company || 'Egis'}`;
    
    navigator.clipboard.writeText(emailText);
    showNotification('Email template copied to clipboard', 'success');
    window.updateEmailStatus(candidate.id, true);
}

// Show email preview in modal
function showEmailPreview(emailData, candidate) {
    const summary = candidate.screening_summary || {};
    
    openModal(`
        <div class="p-8 max-w-3xl">
            <h3 class="text-2xl font-bold mb-4">Generated Email Preview</h3>
            
            <!-- Email Preview -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-400 mb-1">To:</p>
                    <p class="font-medium">${summary.email || 'candidate@email.com'}</p>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-400 mb-1">Subject:</p>
                    <p class="font-medium text-cyan-400">${emailData.subject}</p>
                </div>
                
                <div class="border-t border-gray-700 pt-4">
                    <div class="whitespace-pre-wrap">${emailData.body}</div>
                </div>
            </div>
            
            <!-- Personalization Points -->
            ${emailData.key_personalization_points?.length > 0 ? `
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Personalization Points Used:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        ${emailData.key_personalization_points.map(point => 
                            `<li class="text-sm text-gray-300">${point}</li>`
                        ).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <!-- Tone Analysis -->
            ${emailData.tone_analysis ? `
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-2">Tone Analysis:</h4>
                    <p class="text-sm text-gray-300">${emailData.tone_analysis}</p>
                </div>
            ` : ''}
            
            <!-- Follow-up Suggestion -->
            ${emailData.follow_up_suggestion ? `
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-2">Follow-up Strategy:</h4>
                    <p class="text-sm text-gray-300">${emailData.follow_up_suggestion}</p>
                </div>
            ` : ''}
            
            <!-- Actions -->
            <div class="flex gap-3 justify-end">
                <button class="btn-secondary" onclick="window.regenerateEmail('${candidate.id}')">
                    Regenerate
                </button>
                <button class="btn-secondary" onclick="window.generateEmail('${candidate.id}', 'linkedin')">
                    Generate LinkedIn Message
                </button>
                <button class="btn-primary" onclick="window.closeModal()">
                    Close
                </button>
            </div>
        </div>
    `);
}

// Email helper functions
window.regenerateEmail = async (candidateId) => {
    closeModal();
    await generateEmail(candidateId, 'initial');
};

window.generateFollowUpEmail = async (candidateId) => {
    await generateEmail(candidateId, 'followup');
};

window.generateLinkedInMessage = async (candidateId) => {
    await generateEmail(candidateId, 'linkedin');
};

// Toggle email dropdown menu
window.toggleEmailMenu = (candidateId) => {
    const menu = document.getElementById(`email-menu-${candidateId}`);
    if (!menu) return;
    
    // Close all other dropdowns
    document.querySelectorAll('.dropdown-menu').forEach(m => {
        if (m.id !== `email-menu-${candidateId}`) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle current menu
    menu.classList.toggle('hidden');
    
    // Close on outside click
    if (!menu.classList.contains('hidden')) {
        setTimeout(() => {
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.dropdown-container')) {
                    menu.classList.add('hidden');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }, 100);
    }
};

// =============== ADDITIONAL WINDOW FUNCTION EXPORTS ===============

window.generateVerbalScript = generateVerbalScript;
window.showVerbalScript = showVerbalScript;
window.viewCandidateDetails = viewCandidateDetails;
window.deleteCandidate = deleteCandidate;
window.deletePosition = deletePosition;
window.deleteKnowledgeDoc = deleteKnowledgeDoc;
window.addPosition = addPosition;
window.addDemobProfile = addDemobProfile;
window.editDemobProfile = editDemobProfile;
window.viewDemobDetails = viewDemobDetails;
window.viewDemobMatches = viewDemobMatches;
window.runDemobMatching = runDemobMatching;
window.exportDemobData = exportDemobData;

// Project management functions
window.openAddProjectModal = openAddProjectModal;
window.addProject = addProject;
window.editProject = editProject;
window.deleteProject = deleteProject;

// Modal functions
window.openAddPositionModal = openAddPositionModal;
window.openAddDemobModal = openAddDemobModal;
window.openSettingsModal = openSettingsModal;
window.openUserManagement = openUserManagement;

// Database management
window.clearDatabase = clearDatabase;
window.importDatabaseCSV = importDatabaseCSV;
window.addToDatabaseFromCandidates = addToDatabaseFromCandidates;
window.removeDatabaseCandidate = removeDatabaseCandidate;
window.showDatabaseCandidateDetails = showDatabaseCandidateDetails;
window.changeDatabasePageSize = changeDatabasePageSize;
window.navigateDatabasePage = navigateDatabasePage;

// Call notes functions
window.saveCallNotes = saveCallNotes;
window.exportCallScript = exportCallScript;
window.printScript = printScript;

// Analytics functions
window.calculateAnalytics = calculateAnalytics;
window.exportAnalyticsReport = exportAnalyticsReport;

// Configuration functions
window.saveAPIKey = saveAPIKey;
window.saveRecruiterName = saveRecruiterName;
window.testAPIKey = testAPIKey;

// Knowledge base functions
window.processKnowledgeFiles = processKnowledgeFiles;
window.uploadKnowledgeFiles = uploadKnowledgeFiles;
window.deleteKnowledgeItem = deleteKnowledgeItem;

// Filter functions
window.filterCandidates = filterCandidates;
window.setInterestFilter = setInterestFilter;
window.setEmailFilter = setEmailFilter;
window.clearFilters = clearFilters;

// Utility functions for formatting
window.formatDate = formatDate;
window.formatFileSize = formatFileSize;
window.getMatchScoreClass = getMatchScoreClass;
window.getComplianceIcon = getComplianceIcon;

// Email functions
window.generateEmail = generateEmail;
window.regenerateEmail = regenerateEmail;
window.generateFollowUpEmail = generateFollowUpEmail;
window.generateLinkedInMessage = generateLinkedInMessage;
window.toggleEmailMenu = toggleEmailMenu;
window.showEmailPreview = showEmailPreview;
window.buildEmailPrompt = buildEmailPrompt;
window.generateTemplateEmail = generateTemplateEmail;

// =============== FILE PROCESSING FUNCTIONS ===============

// Process files main function
window.processFiles = processFiles;
window.processWithRecruitProAI = processWithRecruitProAI;
window.processWithDatabaseAI = processWithDatabaseAI;
window.processBatchWithSingleAPI = processBatchWithSingleAPI;

// File readers
window.readPdfFile = readPdfFile;
window.readDocxFile = readDocxFile;
window.readExcelFile = readExcelFile;

// Database operations
window.checkDuplicateCV = checkDuplicateCV;
window.saveCandidateToDatabase = saveCandidateToDatabase;
window.loadDatabaseCandidates = loadDatabaseCandidates;
window.updateDatabaseStatistics = updateDatabaseStatistics;

// API functions
window.callGemini2API = callGemini2API;

// Enhanced context builder
window.buildEnhancedKnowledgeContext = buildEnhancedKnowledgeContext;

// Batch processing
window.processBatchCVs = processBatchCVs;
window.processFilesIndividually = processFilesIndividually;
window.processDatabaseFiles = processDatabaseFiles;
window.processIndividualCV = processIndividualCV;
window.saveBatchResults = saveBatchResults;

// =============== EVENT LISTENERS SETUP ===============

function setupEventListeners() {
    // Sidebar navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            const view = e.currentTarget.dataset.view;
            if (view) switchView(view);
        });
    });
    
    // Project selector
    document.getElementById('active-project-select').addEventListener('change', (e) => {
        const projectId = e.target.value;
        if (projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) setActiveProject(project);
        }
    });
    
    // Settings button
    document.getElementById('config-btn').addEventListener('click', () => {
        openSettingsModal();
    });
    
    // Sign out button
    document.getElementById('signout-btn').addEventListener('click', async () => {
        if (confirm('Are you sure you want to sign out?')) {
            await auth.signOut();
        }
    });
    
    // Auth buttons
    document.getElementById('google-signin')?.addEventListener('click', async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await auth.signInWithPopup(provider);
        } catch (error) {
            showNotification('Authentication failed: ' + error.message, 'error');
        }
    });
    
    document.getElementById('anonymous-signin')?.addEventListener('click', async () => {
        try {
            await auth.signInAnonymously();
        } catch (error) {
            showNotification('Guest login failed: ' + error.message, 'error');
        }
    });
    
    // File upload handlers
    document.getElementById('file-upload-input').addEventListener('change', (e) => {
        if (e.target.files.length > 0) processFiles(e.target.files);
        e.target.value = '';
    });
    
    document.getElementById('knowledge-upload-input').addEventListener('change', (e) => {
        if (e.target.files.length > 0) processKnowledgeFiles(e.target.files);
        e.target.value = '';
    });
    
    document.getElementById('positions-upload-input').addEventListener('change', (e) => {
        if (e.target.files.length > 0) processPositionsFile(e.target.files[0]);
        e.target.value = '';
    });
    
    document.getElementById('demob-upload-input').addEventListener('change', (e) => {
        if (e.target.files.length > 0) processDemobFile(e.target.files[0]);
        e.target.value = '';
    });
    
    document.getElementById('cv-database-input').addEventListener('change', (e) => {
        if (e.target.files.length > 0) processDatabaseFiles(e.target.files);
        e.target.value = '';
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K for quick search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('database-search')?.focus();
        }
        
        // Escape to close modal
        if (e.key === 'Escape') {
            closeModal();
        }
        
        // Ctrl/Cmd + E for email generation
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            const selectedCandidate = document.querySelector('.candidate-card.selected');
            if (selectedCandidate) {
                const candidateId = selectedCandidate.dataset.candidateId;
                if (candidateId) generateEmail(candidateId);
            }
        }
    });
    
    // Global click handler for dropdowns
    document.addEventListener('click', (e) => {
        // Close dropdowns when clicking outside
        if (!e.target.closest('.dropdown-container')) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });
}

// =============== INITIALIZE APPLICATION ===============

async function initializeApp() {
    try {
        // Load saved settings
        const savedApiKey = localStorage.getItem('gemini_api_key');
        const savedRecruiterName = localStorage.getItem('recruiter_name');
        const savedProcessingMode = localStorage.getItem('processing_mode');
        const savedPageSize = localStorage.getItem('database_page_size');
        const savedBatchSize = localStorage.getItem('batch_size');
        
        if (savedProcessingMode) {
            forceProcessingMode = savedProcessingMode;
        }
        
        if (savedPageSize) {
            databasePageSize = parseInt(savedPageSize) || 25;
        }
        
        if (savedBatchSize) {
            BATCH_SIZE = parseInt(savedBatchSize) || 5;
        }
        
        // Setup event listeners
        setupEventListeners();
        
        // Check authentication state
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userId = user.uid;
                
                // Update UI with user info
                const initials = user.displayName ? 
                    user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 
                    'U';
                const userInitialsEl = document.getElementById('user-initials');
                if (userInitialsEl) userInitialsEl.textContent = initials;
                
                // Hide auth, show app
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                // Load user permissions
                await loadUserPermissions();
                
                // Setup database listeners
                setupProjectsListener();
                setupDatabaseListener();
                
                if (userPermissions.view_demob) {
                    setupDemobListener();
                }
                
                // Setup candidates listener for active project
                if (activeProject) {
                    setupCandidatesListener(activeProject.id);
                }
                
                // Initialize PDF.js
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }
                
                // Load dashboard
                switchView('dashboard');
                
                // Check for URL parameters (deep linking)
                const urlParams = new URLSearchParams(window.location.search);
                const view = urlParams.get('view');
                const projectId = urlParams.get('project');
                const candidateId = urlParams.get('candidate');
                
                if (projectId) {
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        await setActiveProject(project);
                    }
                }
                
                if (view) {
                    switchView(view);
                }
                
                if (candidateId && view === 'candidates') {
                    setTimeout(() => {
                        viewCandidateDetails(candidateId);
                    }, 1000);
                }
                
                // Show welcome message
                const hour = new Date().getHours();
                const greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
                showNotification(`${greeting}, ${user.displayName || 'Recruiter'}! Welcome to RecruitPro`, 'info');
                
            } else {
                // Show auth, hide app
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
                
                // Clean up listeners
                Object.values(unsubscribes).forEach(unsub => {
                    if (unsub) unsub();
                });
                
                // Clear state
                userId = null;
                userRole = 'viewer';
                userPermissions = {};
                activeProject = null;
                projects = [];
                candidates = [];
                demobProfiles = [];
                knowledgeBase = {};
                positions = {};
                databaseCandidates = [];
                filteredCandidates = [];
                filteredDatabaseCandidates = [];
            }
            
            showLoading(false);
        });
        
    } catch (error) {
        console.error('Initialization error:', error);
        showNotification('Failed to initialize app: ' + error.message, 'error');
        showLoading(false);
    }
}

// =============== PERFORMANCE MONITORING ===============

if ('performance' in window) {
    window.addEventListener('load', () => {
        const perfData = window.performance.timing;
        const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
        console.log('Page load time:', pageLoadTime, 'ms');
        
        // Track slow loads
        if (pageLoadTime > 3000) {
            console.warn('Slow page load detected:', pageLoadTime, 'ms');
            // Could send to analytics service
        }
        
        // Monitor memory usage
        if (performance.memory) {
            console.log('Memory usage:', {
                used: Math.round(performance.memory.usedJSHeapSize / 1048576) + ' MB',
                total: Math.round(performance.memory.totalJSHeapSize / 1048576) + ' MB',
                limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) + ' MB'
            });
        }
    });
}

// =============== SERVICE WORKER REGISTRATION ===============

if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('Service Worker registered:', registration);
            })
            .catch(err => {
                console.log('Service Worker registration failed:', err);
            });
    });
}

// =============== ERROR HANDLING ===============

window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    
    // Don't show Firebase auth errors to user
    if (event.error?.message?.includes('auth/')) {
        event.preventDefault();
        return;
    }
    
    // Show user-friendly error messages
    if (event.error?.message?.includes('network')) {
        showNotification('Network error. Please check your connection.', 'error');
    } else if (event.error?.message?.includes('Firebase')) {
        showNotification('Database connection issue. Please refresh the page.', 'error');
    }
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    
    // Handle specific rejection types
    if (event.reason?.message?.includes('quota')) {
        showNotification('Storage quota exceeded. Please clear some data.', 'error');
    }
});

// =============== START APPLICATION ===============

// Start initialization when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    initializeApp();
}

        
    </script>
</body>
</html>
